<!DOCTYPE html>
<!-- Page for viewing projects as cards -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Project Board</title>

    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {};
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="operational_ui.css">

    <!-- Font Awesome icons loaded via menu.js -->
</head>
<body class="ops-body">
<div class="flex min-h-screen">
    <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-transparent p-6 overflow-y-auto"></nav>
    <main class="ops-main flex-1 min-w-0 overflow-x-auto space-y-6">
        <h1 class="text-2xl font-semibold mb-4 text-indigo-700">Project Board</h1>
        <p class="mb-4">Browse all active projects in a card layout.</p>

        <section class="cards cards-solid cards-tight space-y-4">
            <div class="flex flex-col lg:flex-row lg:items-end gap-3">
                <label class="flex-1">
                    <span class="block text-sm font-semibold mb-1">Search Projects</span>
                    <input id="project-search" type="text" placeholder="Search name or description" class="w-full border border-gray-300 rounded px-3 py-2" aria-label="Search projects by name or description">
                </label>
                <label>
                    <span class="block text-sm font-semibold mb-1">Funding Source</span>
                    <select id="funding-filter" class="border border-gray-300 rounded px-3 py-2 min-w-40" aria-label="Filter projects by funding source">
                        <option value="">All funding</option>
                    </select>
                </label>
                <label>
                    <span class="block text-sm font-semibold mb-1">Sort</span>
                    <select id="project-sort" class="border border-gray-300 rounded px-3 py-2 min-w-40" aria-label="Sort projects by score or risk">
                        <option value="score_desc">Score: high to low</option>
                        <option value="score_asc">Score: low to high</option>
                        <option value="risk_desc">Risk: high to low</option>
                        <option value="risk_asc">Risk: low to high</option>
                    </select>
                </label>
            </div>

            <div class="flex flex-wrap gap-2" id="status-filters">
                <button type="button" class="status-chip px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700" data-filter="high_risk" aria-label="Filter to high risk projects">High Risk</button>
                <button type="button" class="status-chip px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700" data-filter="over_budget" aria-label="Filter to over budget projects">Over Budget</button>
            </div>

            <div class="flex flex-wrap gap-2" id="summary-chips"></div>
        </section>

        <section class="cards">
            <div id="projects-board" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>
    </main>
</div>

<script src="js/menu.js"></script>
<script src="js/input_help.js"></script>
<script>
function fmtMoney(v){
    return 'Â£' + (parseFloat(v) || 0).toFixed(2);
}

function scoreBadge(score){
    const s = parseInt(score, 10) || 0;
    const colors = {
        1: 'bg-green-500',
        2: 'bg-lime-400',
        3: 'bg-yellow-500',
        4: 'bg-orange-500',
        5: 'bg-red-600'
    };
    const colorClass = colors[s] || 'bg-gray-300';
    return `<span class="inline-block px-2 py-0.5 rounded text-xs ${colorClass} text-black">${s}</span>`;
}


function renderStars(score, minScore, maxScore){
    const s = parseFloat(score) || 0;
    const min = parseFloat(minScore) || 0;
    const max = parseFloat(maxScore) || 0;
    let starCount = 3;
    if(max > min){
        starCount = Math.round(((s - min) / (max - min)) * 4) + 1;
    }
    starCount = Math.max(1, Math.min(5, starCount));
    let stars = '';
    for(let i = 0; i < 5; i++){
        if(i < starCount){
            stars += '<i class="fas fa-star text-yellow-500 text-xs"></i>';
        } else {
            stars += '<i class="far fa-star text-gray-300 text-xs"></i>';
        }
    }
    return stars;
}


async function loadProjects(){
    // Client-side filtering keeps the existing render pipeline simple; add query params in projects.php for larger datasets.
    const res = await fetch('../php_backend/public/projects.php');
    const projects = await res.json();
    const searchInput = document.getElementById('project-search');
    const fundingFilter = document.getElementById('funding-filter');
    const sortSelect = document.getElementById('project-sort');
    const board = document.getElementById('projects-board');
    const summary = document.getElementById('summary-chips');
    const statusChips = Array.from(document.querySelectorAll('.status-chip'));

    const fundingSources = Array.from(new Set(projects.map(p => (p.funding_source || '').trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b));
    fundingFilter.innerHTML = '<option value="">All funding</option>';
    fundingSources.forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = source;
        fundingFilter.appendChild(option);
    });

    function isHighRisk(project){
        return (parseInt(project.benefit_risk, 10) || 0) >= 4;
    }

    function isOverBudget(project){
        return (parseFloat(project.spent) || 0) > (parseFloat(project.cost_medium) || 0);
    }

    function updateSummary(filteredProjects){
        const totalMidCost = filteredProjects.reduce((sum, p) => sum + (parseFloat(p.cost_medium) || 0), 0);
        const totalSpent = filteredProjects.reduce((sum, p) => sum + (parseFloat(p.spent) || 0), 0);
        summary.innerHTML = `
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800">Projects: ${filteredProjects.length}</span>
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800">Total Mid Cost: ${fmtMoney(totalMidCost)}</span>
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">Total Spent: ${fmtMoney(totalSpent)}</span>
        `;
    }

    function applyFiltersAndRender(){
        const searchTerm = searchInput.value.trim().toLowerCase();
        const funding = fundingFilter.value;
        const sortValue = sortSelect.value;
        const activeStatusFilters = statusChips.filter(chip => chip.dataset.active === '1').map(chip => chip.dataset.filter);

        let filteredProjects = projects.filter(project => {
            const name = (project.name || '').toLowerCase();
            const description = (project.description || '').toLowerCase();
            const matchesSearch = !searchTerm || name.includes(searchTerm) || description.includes(searchTerm);
            const matchesFunding = !funding || (project.funding_source || '') === funding;
            const matchesStatus = activeStatusFilters.every(filter => {
                if(filter === 'high_risk') return isHighRisk(project);
                if(filter === 'over_budget') return isOverBudget(project);
                return true;
            });
            return matchesSearch && matchesFunding && matchesStatus;
        });

        filteredProjects = filteredProjects.slice().sort((a, b) => {
            const scoreA = parseFloat(a.score) || 0;
            const scoreB = parseFloat(b.score) || 0;
            const riskA = parseFloat(a.benefit_risk) || 0;
            const riskB = parseFloat(b.benefit_risk) || 0;
            if(sortValue === 'score_asc') return scoreA - scoreB;
            if(sortValue === 'risk_desc') return riskB - riskA;
            if(sortValue === 'risk_asc') return riskA - riskB;
            return scoreB - scoreA;
        });

        updateSummary(filteredProjects);

        const scores = filteredProjects.map(p => parseFloat(p.score) || 0);
        const minScore = scores.length ? Math.min(...scores) : 0;
        const maxScore = scores.length ? Math.max(...scores) : 0;

        board.innerHTML = '';
        filteredProjects.forEach(p => {
        const card = document.createElement('div');
        card.className = 'cards cards-tight flex flex-col space-y-2';

        const header = document.createElement('div');
        header.className = 'flex justify-between items-start';
        const title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-indigo-700';
        title.textContent = p.name;
        const icons = document.createElement('div');
        icons.className = 'flex space-x-2 text-gray-600';
        icons.innerHTML = `
            <i class="fas fa-edit cursor-pointer" aria-label="Edit"></i>
            <i class="fas fa-box-archive cursor-pointer" aria-label="Archive"></i>
            <i class="fas fa-trash cursor-pointer" aria-label="Delete"></i>
        `;
        header.appendChild(title);
        header.appendChild(icons);
        card.appendChild(header);

        const details = document.createElement('div');
        details.className = 'space-y-1 text-sm';

        const desc = document.createElement('p');
        desc.innerHTML = `<span class="font-semibold">Description:</span> ${p.description || ''}`;
        const rationale = document.createElement('p');
        rationale.innerHTML = `<span class="font-semibold">Rationale:</span> ${p.rationale || ''}`;
        details.appendChild(desc);
        details.appendChild(rationale);

        const table = document.createElement('table');
        table.className = 'ops-native-table';
        table.innerHTML = `
            <tbody>
                <tr>
                    <th scope="row">Cost Low</th><td>${fmtMoney(p.cost_low)}</td>
                    <th scope="row">Cost Medium</th><td>${fmtMoney(p.cost_medium)}</td>
                </tr>
                <tr>
                    <th scope="row">Cost High</th><td>${fmtMoney(p.cost_high)}</td>
                    <th scope="row">Funding</th><td>${p.funding_source || ''}</td>
                </tr>
                <tr>
                    <th scope="row">Recurring Cost</th><td>${fmtMoney(p.recurring_cost)}</td>
                    <th scope="row">Estimated Time</th><td>${p.estimated_time || ''}</td>
                </tr>
                <tr>
                    <th scope="row">Expected Lifespan</th><td>${p.expected_lifespan || ''}</td>
                    <th scope="row">Financial Benefit</th><td>${scoreBadge(p.benefit_financial)}</td>
                </tr>
                <tr>
                    <th scope="row">Quality Benefit</th><td>${scoreBadge(p.benefit_quality)}</td>
                    <th scope="row">Risk Benefit</th><td>${scoreBadge(p.benefit_risk)}</td>
                </tr>
                <tr>
                    <th scope="row">Sustainability Benefit</th><td>${scoreBadge(p.benefit_sustainability)}</td>
                    <th scope="row">Score</th><td>${renderStars(p.score, minScore, maxScore)}</td>
                </tr>
                <tr>
                    <th scope="row">Dependencies</th><td>${p.dependencies || ''}</td>
                    <th scope="row">Risks</th><td>${p.risks || ''}</td>
                </tr>
            </tbody>
        `;
        details.appendChild(table);
        card.appendChild(details);

        const spent = document.createElement('h4');
        spent.className = 'text-indigo-700 font-semibold';
        spent.textContent = `Spent: ${fmtMoney(p.spent)}`;
        card.appendChild(spent);

        const [editIcon, archiveIcon, deleteIcon] = Array.from(icons.children);
        editIcon.addEventListener('click', () => {
            window.location.href = `project_add.html?id=${p.id}`;
        });
        archiveIcon.addEventListener('click', async () => {
            await fetch('../php_backend/public/projects.php', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: p.id, archived: 1})
            });
            loadProjects();
            showMessage('Project archived');
        });
        deleteIcon.addEventListener('click', async () => {
            if(!confirm('Delete this project?')) return;
            await fetch('../php_backend/public/projects.php', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: p.id})
            });
            loadProjects();
            showMessage('Project deleted');
        });

        board.appendChild(card);
    });

        if(!filteredProjects.length){
            board.innerHTML = '<div class="cards cards-solid cards-tight text-sm text-gray-600">No projects match the selected filters.</div>';
        }
    }

    searchInput.addEventListener('input', applyFiltersAndRender);
    fundingFilter.addEventListener('change', applyFiltersAndRender);
    sortSelect.addEventListener('change', applyFiltersAndRender);
    statusChips.forEach(chip => {
        chip.addEventListener('click', () => {
            const active = chip.dataset.active === '1';
            chip.dataset.active = active ? '0' : '1';
            chip.classList.toggle('bg-gray-200', active);
            chip.classList.toggle('text-gray-700', active);
            chip.classList.toggle('bg-indigo-600', !active);
            chip.classList.toggle('text-white', !active);
            applyFiltersAndRender();
        });
    });

    applyFiltersAndRender();
}

loadProjects();
</script>
<script src="js/overlay.js"></script>
</body>
</html>

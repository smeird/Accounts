<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Graphs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_simple.min.css">
</head>
<body class="bg-gradient-to-b from-indigo-50 to-white font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="w-64 flex-shrink-0 bg-white border-r p-6"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6 space-y-4">
            <h1 class="text-2xl font-semibold text-indigo-700">Graphs</h1>
            <p class="mb-4">Explore a collection of charts that illustrate your income and spending patterns. Choose a year to see how your finances evolve and compare categories or tags visually.</p>
            <label for="year-select" class="block">Year:
                <select id="year-select" class="border p-2 rounded w-full"></select>
            </label>

            <div class="mb-4 border-b" id="graph-tab-bar">
                <nav class="flex flex-wrap gap-2" id="graph-tabs">
                    <button class="tab-button px-3 py-2 rounded bg-indigo-100 text-indigo-700" data-target="income-sunburst">Income Sunburst</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="outgoing-sunburst">Outgoing Sunburst</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="monthly-chart-container">Monthly Spend</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="cumulative-chart-container">Cumulative Spend</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="pie-chart-container">Category Pie</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="income-tag-container">Income Tags</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="outgoing-tag-container">Outgoing Tags</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="scatter-chart-container">Scatter</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="network-graph-container">Segment Network</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="treegraph-container">Segment Tree</button>
                    <button class="tab-button px-3 py-2 rounded" data-target="segment-section">Segments</button>
                </nav>
            </div>

            <div id="income-sunburst" class="tab-content bg-white p-6 rounded shadow"><div id="income-sunburst-chart" style="height:600px"></div></div>
            <div id="outgoing-sunburst" class="tab-content bg-white p-6 rounded shadow hidden"><div id="outgoing-sunburst-chart" style="height:600px"></div></div>
            <div id="monthly-chart-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="monthly-chart" style="height:400px"></div></div>
            <div id="cumulative-chart-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="cumulative-chart" style="height:400px"></div></div>
            <div id="pie-chart-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="pie-chart" style="height:400px"></div></div>
            <div id="income-tag-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="income-tag-chart" style="height:400px"></div></div>
            <div id="outgoing-tag-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="outgoing-tag-chart" style="height:400px"></div></div>
            <div id="scatter-chart-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="scatter-chart" style="height:400px"></div></div>
            <div id="network-graph-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="network-graph" style="height:600px"></div></div>
            <div id="treegraph-container" class="tab-content bg-white p-6 rounded shadow hidden"><div id="treegraph-chart" style="height:600px"></div></div>
            <div id="segment-section" class="tab-content bg-white p-6 rounded shadow hidden space-y-4">
                <h2 class="text-xl font-semibold">Segment Totals</h2>
                <div id="segment-table"></div>
                <div id="segment-chart" style="height:400px"></div>
            </div>
        </main>
    </div>

    <script src="js/menu.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/modules/sunburst.js"></script>
    <script src="https://code.highcharts.com/modules/networkgraph.js"></script>
    <script src="https://code.highcharts.com/modules/treegraph.js"></script>

    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script>

    // Retrieve data for the chosen year and draw charts with 3D bars where applicable
    const gradientColors = ['#4B0082', '#40826D', '#50C878', '#AAF0D1'];
    let segmentTable;

    function columnTooltip(){
        const total = this.series.yData.reduce((sum, v) => sum + v, 0);
        const pct = total ? (this.y / total * 100) : 0;
        return `<b>${this.series.name}</b><br/>${this.category}: £${Highcharts.numberFormat(this.y, 2)} (${Highcharts.numberFormat(pct, 1)}% of total)`;
    }

    function pieTooltip(){
        return `<b>${this.point.name}</b><br/>£${Highcharts.numberFormat(this.y, 2)} (${Highcharts.numberFormat(this.percentage, 1)}%)`;
    }

    function sunburstTooltip(){
        const sum = (this.node && this.node.childrenTotal) || this.value;
        const total = this.series.points[0].node.childrenTotal;
        const pct = total ? (sum / total * 100) : 0;
        return `<b>${this.point.name}</b><br/>£${Highcharts.numberFormat(sum, 2)} (${Highcharts.numberFormat(pct, 1)}%)`;
    }

    function buildHierarchy(yearly, categories, includeTags = true){
        const makeId = str => (str ? String(str).replace(/\s+/g, '_') : '');
        const categoryMap = {};
        categories.forEach(c => {
            if (c.name) {
                categoryMap[c.name] = c.segment_name || 'Not Segmented';
            }
        });
        const data = [{ id: 'root', name: 'Total' }];
        const segmentIds = {};
        const segmentTotals = {};
        const categoryTotals = {};
        (yearly.categories || []).forEach(c => {
            if (!c.name) return;
            const segName = categoryMap[c.name] || 'Not Segmented';
            let segId = segmentIds[segName];
            if (!segId) {
                segId = 'seg_' + makeId(segName);
                segmentIds[segName] = segId;
                data.push({ id: segId, parent: 'root', name: segName });
            }
            const catId = 'cat_' + makeId(c.name);
            const total = Math.abs(parseFloat(c.total));
            const catNode = { id: catId, parent: segId, name: c.name };
            if (!includeTags) { catNode.value = total; }
            data.push(catNode);
            categoryTotals[c.name] = { id: catId, total, segment: segName, fromYearly: true };
            segmentTotals[segName] = (segmentTotals[segName] || 0) + total;
        });
        if (includeTags) {
            const tagSums = {};
            (yearly.tags || []).forEach(t => {
                if (!t.name || !t.category) return;
                let catInfo = categoryTotals[t.category];
                let catId;
                if (catInfo) {
                    catId = catInfo.id;
                } else {
                    const segName = categoryMap[t.category] || 'Not Segmented';
                    let segId = segmentIds[segName];
                    if (!segId) {
                        segId = 'seg_' + makeId(segName);
                        segmentIds[segName] = segId;
                        data.push({ id: segId, parent: 'root', name: segName });
                    }
                    catId = 'cat_' + makeId(t.category);
                    data.push({ id: catId, parent: segId, name: t.category });
                    catInfo = categoryTotals[t.category] = { id: catId, total: 0, segment: segName, fromYearly: false };
                }
                const tagId = 'tag_' + makeId(t.name) + '_' + makeId(t.category);
                const value = Math.abs(parseFloat(t.total));
                data.push({ id: tagId, parent: catId, name: t.name, value });
                tagSums[catId] = (tagSums[catId] || 0) + value;
                if (!catInfo.fromYearly) {
                    catInfo.total += value;
                    segmentTotals[catInfo.segment] = (segmentTotals[catInfo.segment] || 0) + value;
                }
            });
            Object.values(categoryTotals).forEach(ct => {
                const tagged = tagSums[ct.id] || 0;
                const diff = ct.total - tagged;
                if (Math.abs(diff) > 0.01) {
                    data.push({ id: 'tag_other_' + ct.id, parent: ct.id, name: 'Other', value: diff });
                }
            });
        }
        if (yearly.segments) {
            const check = {};
            yearly.segments.forEach(s => {
                if (s.name) {
                    check[s.name] = Math.abs(parseFloat(s.total));
                }
            });
            Object.entries(segmentTotals).forEach(([name, total]) => {
                const reported = check[name] || 0;
                if (Math.abs(reported - total) > 0.01) {
                    console.warn(`Segment total mismatch for ${name}: expected ${reported} calculated ${total}`);
                }
            });
        }
        return { data, segmentTotals };
    }

    function loadYear(year){
        Promise.all([
            fetch('../php_backend/public/dashboard.php?year=' + year).then(r => r.json()),
            fetch('../php_backend/public/yearly_dashboard.php?year=' + year).then(r => r.json()),
            fetch('../php_backend/public/categories.php').then(r => r.json())
        ]).then(([monthly, yearly, categories]) => {
            const months = monthly.map(m => new Date(0, m.month - 1).toLocaleString('default', { month: 'short' }));
            const totals = monthly.map(m => parseFloat(m.spent));
            const categorySeries = yearly.categories.map(c => ({
                name: c.name,
                data: months.map((_, i) => parseFloat(c[String(i + 1)]) || 0)
            }));

            Highcharts.chart('monthly-chart', {
                chart: {
                    type: 'column',

                    options3d: { enabled: true, alpha: 0, beta: 0, depth: 50 }

                },
                title: { text: 'Monthly Spending by Category' },
                xAxis: { categories: months },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: columnTooltip },
                plotOptions: { column: { stacking: 'normal', depth: 40 } },
                series: categorySeries
            });

            const cumulative = totals.reduce((acc, val) => {
                const last = acc.length ? acc[acc.length - 1] : 0;
                acc.push(last + val);
                return acc;
            }, []);
            const categoryCumulative = categorySeries.map(cs => ({
                name: cs.name,
                data: cs.data.reduce((acc, val) => {
                    const last = acc.length ? acc[acc.length - 1] : 0;
                    acc.push(last + val);
                    return acc;
                }, [])
            }));
            Highcharts.chart('cumulative-chart', {
                chart: {
                    type: 'column',

                    options3d: { enabled: true, alpha: 0, beta: 0, depth: 50 }

                },
                title: { text: 'Cumulative Spending by Category' },
                xAxis: { categories: months },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: columnTooltip },
                plotOptions: { column: { stacking: 'normal', depth: 40 } },
                series: categoryCumulative
            });

            const catData = yearly.categories
                .filter(c => parseFloat(c.total) < 0)
                .map(c => ({ name: c.name, y: Math.abs(parseFloat(c.total)) }));
            Highcharts.chart('pie-chart', {
                chart: {

                    type: 'pie'

                },
                title: { text: 'Outgoing Category Breakdown' },
                tooltip: { pointFormatter: pieTooltip },
                plotOptions: { pie: { depth: 35 } },
                series: [{ name: 'Categories', data: catData }]
            });

            const incomeTags = yearly.tags.filter(t => parseFloat(t.total) > 0);
            const outgoingTags = yearly.tags.filter(t => parseFloat(t.total) < 0);

            Highcharts.chart('income-tag-chart', {
                colors: gradientColors,
                chart: {
                    type: 'bar',
                    options3d: { enabled: true, alpha: 0, beta: 0, depth: 50 }
                },
                title: { text: 'Income Tag Totals' },
                xAxis: { categories: incomeTags.map(t => t.name) },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: columnTooltip },
                plotOptions: { bar: { depth: 40 } },
                series: [{ name: 'Total', data: incomeTags.map(t => parseFloat(t.total)), colorByPoint: true }]
            });

            Highcharts.chart('outgoing-tag-chart', {
                colors: gradientColors,
                chart: {
                    type: 'bar',
                    options3d: { enabled: true, alpha: 0, beta: 0, depth: 50 }
                },
                title: { text: 'Outgoing Tag Totals' },
                xAxis: { categories: outgoingTags.map(t => t.name) },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: columnTooltip },
                plotOptions: { bar: { depth: 40 } },
                series: [{ name: 'Total', data: outgoingTags.map(t => Math.abs(parseFloat(t.total))), colorByPoint: true }]
            });

            Highcharts.chart('scatter-chart', {
                colors: gradientColors,
                chart: {

                    type: 'scatter'

                },
                title: { text: 'Monthly Spending Scatter' },
                xAxis: { categories: months, title: { text: 'Month' } },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: columnTooltip },

                series: [{ name: 'Spending', data: totals.map((v, i) => [i, v]), colorByPoint: true }]

            });

            const incomeYearly = {
                segments: yearly.segments.filter(s => parseFloat(s.total) > 0),
                categories: yearly.categories.filter(c => parseFloat(c.total) > 0),
                tags: yearly.tags.filter(t => parseFloat(t.total) > 0)
            };
            const outgoingYearly = {
                segments: yearly.segments.filter(s => parseFloat(s.total) < 0),
                categories: yearly.categories.filter(c => parseFloat(c.total) < 0),
                tags: yearly.tags.filter(t => parseFloat(t.total) < 0)
            };
            const segmentTotals = renderSunburst(outgoingYearly, categories, 'outgoing-sunburst-chart', 'Outgoing Segments, Categories and Tags');
            renderSunburst(incomeYearly, categories, 'income-sunburst-chart', 'Income Segments, Categories and Tags');
            const allYearly = { segments: yearly.segments, categories: yearly.categories, tags: yearly.tags };
            const { data: hierarchyData } = buildHierarchy(allYearly, categories, false);
            renderHierarchyCharts(hierarchyData);
            if (segmentTotals.length) {
                renderSegments(segmentTotals);
            }
        }).catch(err => console.error('Graph data load failed', err));
    }

    function renderSunburst(yearly, categories, chartId, chartTitle){
        const { data, segmentTotals } = buildHierarchy(yearly, categories);
        Highcharts.chart(chartId, {
            series: [{
                type: 'sunburst',
                data: data,
                allowDrillToNode: true,
                cursor: 'pointer',
                dataLabels: {
                    formatter: function(){
                        const sum = (this.point.node && this.point.node.childrenTotal) || this.point.value;
                        return sum !== undefined ? `${this.point.name}: £${Highcharts.numberFormat(sum, 2)}` : this.point.name;
                    },
                    filter: { property: 'innerArcLength', operator: '>', value: 8 },
                    style: { fontWeight: 'normal' }
                },
                levels: [
                    { level: 1, colorByPoint: true, dataLabels: { rotationMode: 'parallel', style: { fontWeight: 'normal' } } },
                    { level: 2, colorByPoint: true },
                    { level: 3, colorByPoint: true }
                ]
            }],
            title: { text: chartTitle },
            tooltip: { pointFormatter: sunburstTooltip }
        });
        return Object.entries(segmentTotals).map(([name, total]) => ({ name, total }));
    }

    function renderHierarchyCharts(data){
        const edges = data.filter(d => d.parent).map(d => [d.parent, d.id]);
        const nodes = data.map(d => ({ id: d.id, name: d.name }));
        Highcharts.chart('network-graph', {
            chart: { type: 'networkgraph' },
            title: { text: 'Segment / Category Network' },
            series: [{
                data: edges,
                nodes: nodes,
                dataLabels: { enabled: true, linkFormat: '' }
            }]
        });
        Highcharts.chart('treegraph-chart', {
            title: { text: 'Segment / Category Tree' },
            tooltip: { pointFormatter: sunburstTooltip },
            series: [{
                type: 'treegraph',
                data: data,
                dataLabels: { style: { textOutline: 'none' } }
            }]
        });
    }

    function renderSegments(segments){
        const tableEl = document.getElementById('segment-table');
        tableEl.innerHTML = '';
        segmentTable = tailwindTabulator(tableEl, {
            data: segments,
            layout: 'fitDataStretch',
            columns: [
                { title: 'Name', field: 'name', formatter: function(cell){
                    const value = cell.getValue();
                    const badge = createBadge(value, 'bg-yellow-200 text-yellow-800');
                    const link = document.createElement('a');
                    link.href = `search.html?value=${encodeURIComponent(value)}`;
                    link.appendChild(badge);
                    return link;
                } },
                { title: 'Total', field: 'total', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right', bottomCalc: 'sum', bottomCalcFormatter: 'money', bottomCalcFormatterParams: { symbol: '£', precision: 2 } }
            ]
        });
        Highcharts.chart('segment-chart', {
            colors: gradientColors,
            chart: { type: 'column' },
            title: { text: 'Segment Totals' },
            xAxis: { categories: segments.map(s => s.name) },
            yAxis: { title: { text: 'Amount (£)' }, labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } } },
            tooltip: { pointFormatter: columnTooltip },
            series: [{ name: 'Total', data: segments.map(s => parseFloat(s.total)), colorByPoint: true }]
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetch('../php_backend/public/transaction_months.php')
            .then(resp => resp.json())
            .then(months => {
                const years = Array.from(new Set(months.map(m => m.year))).sort((a,b) => b - a);
                const select = document.getElementById('year-select');
                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    select.appendChild(opt);
                });
                const initial = select.value || years[0];
                select.value = initial;
                loadYear(initial);
            });

        document.getElementById('year-select').addEventListener('change', e => loadYear(e.target.value));

        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(btn => {
            btn.addEventListener('click', () => {
                tabs.forEach(b => b.classList.remove('bg-indigo-100', 'text-indigo-700'));
                contents.forEach(c => c.classList.add('hidden'));
                document.getElementById(btn.dataset.target).classList.remove('hidden');
                btn.classList.add('bg-indigo-100', 'text-indigo-700');
                Highcharts.charts.forEach(c => { if (c) c.reflow(); });
                if (btn.dataset.target === 'segment-section' && segmentTable) {
                    segmentTable.redraw();
                }
            });
        });
    });
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

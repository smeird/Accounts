<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Graphs</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="w-64 bg-white border-r p-6"></nav>
        <main class="flex-1 p-6 space-y-8">
            <h1 class="text-2xl font-semibold">Graphs</h1>
            <label for="year-select" class="block">Year:
                <select id="year-select" class="border p-2 rounded w-full"></select>
            </label>
            <div id="line-chart" style="height:400px"></div>
            <div id="column-chart" style="height:400px"></div>
            <div id="area-chart" style="height:400px"></div>
            <div id="pie-chart" style="height:400px"></div>
            <div id="bar-chart" style="height:400px"></div>
            <div id="scatter-chart" style="height:400px"></div>
        </main>
    </div>

    <script src="js/menu.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
    // Retrieve data for the chosen year and draw a variety of charts
    function loadYear(year){
        Promise.all([
            fetch('../php_backend/public/dashboard.php?year=' + year).then(r => r.json()),
            fetch('../php_backend/public/yearly_dashboard.php?year=' + year).then(r => r.json())
        ]).then(([monthly, yearly]) => {
            const months = monthly.map(m => new Date(0, m.month - 1).toLocaleString('default', { month: 'short' }));
            const totals = monthly.map(m => parseFloat(m.spent));
            const categorySeries = yearly.categories.map(c => ({
                name: c.name,
                data: months.map((_, i) => parseFloat(c[String(i + 1)]) || 0)
            }));

            Highcharts.chart('line-chart', {
                chart: { type: 'line' },
                title: { text: 'Monthly Spending' },
                xAxis: { categories: months },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
                series: [{ name: String(year), data: totals }, ...categorySeries]
            });

            Highcharts.chart('column-chart', {
                chart: { type: 'column' },
                title: { text: 'Monthly Spending (Column)' },
                xAxis: { categories: months },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
                series: [{ name: String(year), data: totals }, ...categorySeries]
            });

            const cumulative = totals.reduce((acc, val) => {
                const last = acc.length ? acc[acc.length - 1] : 0;
                acc.push(last + val);
                return acc;
            }, []);
            const categoryCumulative = categorySeries.map(cs => ({
                name: cs.name,
                data: cs.data.reduce((acc, val) => {
                    const last = acc.length ? acc[acc.length - 1] : 0;
                    acc.push(last + val);
                    return acc;
                }, [])
            }));
            Highcharts.chart('area-chart', {
                chart: { type: 'area' },
                title: { text: 'Cumulative Spending' },
                xAxis: { categories: months },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
                series: [{ name: String(year), data: cumulative }, ...categoryCumulative]
            });

            const catData = yearly.categories.map(c => ({ name: c.name, y: parseFloat(c.total) }));
            Highcharts.chart('pie-chart', {
                chart: { type: 'pie' },
                title: { text: 'Category Breakdown' },
                tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
                series: [{ name: 'Categories', data: catData }]
            });

            const tagNames = yearly.tags.map(t => t.name);
            const tagTotals = yearly.tags.map(t => parseFloat(t.total));
            Highcharts.chart('bar-chart', {
                chart: { type: 'bar' },
                title: { text: 'Tag Totals' },
                xAxis: { categories: tagNames },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
                series: [{ name: 'Total', data: tagTotals }]
            });

            Highcharts.chart('scatter-chart', {
                chart: { type: 'scatter' },
                title: { text: 'Monthly Spending Scatter' },
                xAxis: { categories: months, title: { text: 'Month' } },
                yAxis: {
                    title: { text: 'Amount (£)' },
                    labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } }
                },
                tooltip: { pointFormatter: function(){ return this.category + ': £' + Highcharts.numberFormat(this.y, 2); } },
                series: [{ name: 'Spending', data: totals.map((v, i) => ({ x: i, y: v })) }]
            });
        }).catch(err => console.error('Graph data load failed', err));
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetch('../php_backend/public/transaction_months.php')
            .then(resp => resp.json())
            .then(months => {
                const years = Array.from(new Set(months.map(m => m.year))).sort((a,b) => b - a);
                const select = document.getElementById('year-select');
                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    select.appendChild(opt);
                });
                const initial = select.value || years[0];
                select.value = initial;
                loadYear(initial);
            });

        document.getElementById('year-select').addEventListener('change', e => loadYear(e.target.value));
    });
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

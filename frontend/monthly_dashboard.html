<!DOCTYPE html>
<!-- Dashboard showing monthly spending summaries -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Monthly Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_semantic-ui.min.css">
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="w-64 flex-shrink-0 bg-white border-r p-6"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6">
            <h1 class="text-2xl font-semibold mb-4">Monthly Dashboard</h1>
            <p class="mb-4">View income and outgoings for a chosen month.</p>
            <label for="year-select" class="block">Year:
                <select id="year-select" class="border p-2 rounded w-full" data-help="Select year"></select>
            </label>
            <label for="month-select" class="block mt-2">Month:
                <select id="month-select" class="border p-2 rounded w-full" data-help="Select month"></select>
            </label>

            <div id="totals" class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded shadow text-center">
                    <p class="text-gray-500">Income</p>
                    <p id="income-total" class="text-3xl font-bold">£0.00</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <p class="text-gray-500">Outgoings</p>
                    <p id="outgoings-total" class="text-3xl font-bold">£0.00</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <p class="text-gray-500">Delta</p>
                    <p id="delta-total" class="text-3xl font-bold">£0.00</p>
                </div>
            </div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Tag Totals</h2>
            <div id="tags-table" class="mt-2"></div>
            <div id="tags-chart" class="mt-4" style="height:400px"></div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Category Totals</h2>
            <div id="categories-table" class="mt-2"></div>
            <div id="categories-chart" class="mt-4" style="height:400px"></div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Category & Tag Breakdown</h2>
            <div id="category-tag-donuts" class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="category-tag-income" style="height:400px"></div>
                <div id="category-tag-outgoings" style="height:400px"></div>
            </div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Group Totals</h2>
            <div id="groups-table" class="mt-2"></div>
            <div id="groups-chart" class="mt-4" style="height:400px"></div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
    // Format totals with currency and sign-based colouring
    function totalFormatter(cell){
        const value = cell.getValue();
        const el = cell.getElement();
        el.classList.toggle('text-red-600', value < 0);
        el.classList.toggle('text-green-600', value > 0);
        return '£' + parseFloat(value).toFixed(2);
    }

    // Render a table showing daily totals for the month
    function buildTable(id, data, days){
        const el = document.getElementById(id);
        el.innerHTML = '';

        const dayCols = Array.from({length: days}, (_, i) => ({
            title: String(i + 1),
            field: String(i + 1),
            formatter: 'money',
            formatterParams: { symbol: '£', precision: 2 },
            hozAlign: 'right',
            bottomCalc: 'sum',
            bottomCalcFormatter: totalFormatter
        }));

        const columns = [
            { title: 'Name', field: 'name', bottomCalc: () => 'Total' },
            ...dayCols,
            { title: 'Total', field: 'total', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right', bottomCalc: 'sum', bottomCalcFormatter: totalFormatter }
        ];

        tailwindTabulator(el, {
            data: data,
            layout: 'fitColumns',
            columns: columns
        });
    }

    // Draw a column chart visualising totals
    function buildChart(id, title, data){
        Highcharts.chart(id, {
            chart: { type: 'column' },
            title: { text: title },
            xAxis: { categories: data.map(d => d.name) },
            yAxis: { title: { text: 'Amount (£)' }, labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } } },
            tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
            series: [{ name: 'Total', data: data.map(d => parseFloat(d.total)) }]
        });
    }

    // Render paired donut charts for categories and tags
    function buildDonutCharts(incomeId, outgoingsId, categories, tags){

        const colors = Highcharts.getOptions().colors;

        // Build chart data arrays for income or outgoings
        function createData(isIncome){
            const categoryData = [];
            const tagData = [];
            let colorIndex = 0;
            categories.forEach(c => {
                const total = parseFloat(c.total);
                if ((isIncome && total > 0) || (!isIncome && total < 0)) {
                    const color = colors[colorIndex % colors.length];
                    colorIndex++;
                    categoryData.push({ name: c.name, y: Math.abs(total), color });
                    tags.filter(t => t.category === c.name && ((isIncome && parseFloat(t.total) > 0) || (!isIncome && parseFloat(t.total) < 0))).forEach(t => {
                        tagData.push({
                            name: t.name,
                            y: Math.abs(parseFloat(t.total)),
                            color: Highcharts.color(color).brighten(0.1).get()
                        });
                    });
                }
            });
            return { categoryData, tagData };
        }

        // Render a donut chart into the given element
        function render(id, title, data){
            Highcharts.chart(id, {
                chart: { type: 'pie' },
                title: { text: title },
                tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
                plotOptions: {
                    pie: {
                        dataLabels: {
                            formatter: function(){ return this.point.name + ': £' + Highcharts.numberFormat(this.y, 2); }
                        }
                    }
                },
                series: [
                    { name: 'Categories', data: data.categoryData, size: '60%', dataLabels: { distance: -30 } },
                    { name: 'Tags', data: data.tagData, size: '80%', innerSize: '60%' }
                ]
            });
        }

        const incomeData = createData(true);
        const outData = createData(false);
        render(incomeId, 'Income Categories and Tags', incomeData);
        render(outgoingsId, 'Outgoings Categories and Tags', outData);
    }

    // Fetch and display dashboard data for a specific month
    function loadMonth(year, month){
        fetch('../php_backend/public/monthly_dashboard.php?year=' + year + '&month=' + month)
            .then(resp => resp.json())
            .then(data => {
                const totals = data.totals;
                document.getElementById('income-total').textContent = '£' + parseFloat(totals.income).toFixed(2);
                document.getElementById('outgoings-total').textContent = '£' + parseFloat(totals.outgoings).toFixed(2);
                const deltaEl = document.getElementById('delta-total');
                deltaEl.textContent = '£' + parseFloat(totals.delta).toFixed(2);
                deltaEl.className = (totals.delta >= 0 ? 'text-green-600' : 'text-red-600') + ' text-3xl font-bold';

                const days = new Date(year, month, 0).getDate();

                buildTable('tags-table', data.tags, days);
                buildChart('tags-chart', 'Tag Totals', data.tags);
                buildTable('categories-table', data.categories, days);
                buildChart('categories-chart', 'Category Totals', data.categories);
                buildDonutCharts('category-tag-income', 'category-tag-outgoings', data.categories, data.tags);
                buildTable('groups-table', data.groups, days);
                buildChart('groups-chart', 'Group Totals', data.groups);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetch('../php_backend/public/transaction_months.php')
            .then(resp => resp.json())
            .then(months => {
                const monthsByYear = {};
                months.forEach(m => {
                    if (!monthsByYear[m.year]) { monthsByYear[m.year] = []; }
                    monthsByYear[m.year].push(m.month);
                });

                const yearSelect = document.getElementById('year-select');
                Object.keys(monthsByYear).sort((a,b) => b - a).forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    yearSelect.appendChild(opt);
                    monthsByYear[y].sort((a,b) => b - a);
                });

                const monthSelect = document.getElementById('month-select');
                // Populate the month dropdown based on available data
                function populateMonths(){
                    const y = yearSelect.value;
                    monthSelect.innerHTML = '';
                    (monthsByYear[y] || []).forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        const d = new Date(y, m - 1);
                        opt.textContent = d.toLocaleString('default', { month: 'long' });
                        monthSelect.appendChild(opt);
                    });
                }

                yearSelect.addEventListener('change', () => {
                    populateMonths();
                    loadMonth(yearSelect.value, monthSelect.value);
                });
                populateMonths();
                loadMonth(yearSelect.value, monthSelect.value);
                monthSelect.addEventListener('change', () => loadMonth(yearSelect.value, monthSelect.value));
            });
    });
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>


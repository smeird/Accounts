<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Account Transfers</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {};
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="operational_ui.css">

    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_simple.min.css">

</head>
<body class="ops-body">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-transparent p-6 overflow-y-auto"></nav>
        <main class="ops-main flex-1 min-w-0 overflow-x-auto p-6 space-y-6">
            <section id="transfer-feedback" class="hidden cards cards-tight" role="status" aria-live="polite">
                <p id="transfer-feedback-text" class="text-sm"></p>
            </section>
            <section class="cards cards-tight">
<div id="transfers-table"></div>
            </section>
            <section class="cards cards-tight">
                <h2 class="text-xl font-semibold mb-4 flex items-center justify-between">
                    Marked Transfers
                    <button id="undo-all" class="bg-red-600 text-white px-3 py-1 rounded text-sm" aria-label="Undo all marked transfers"><i class="fas fa-rotate-left inline w-4 h-4 mr-1"></i>Undo All</button>
                </h2>
                <div id="linked-table"></div>
            </section>
            <section class="cards cards-tight">
                <h2 class="text-xl font-semibold mb-4">Link Transactions as Transfer</h2>
                <form id="link-form" class="space-y-4">
                    <input type="number" id="id1" placeholder="First transaction ID" class="border p-2 rounded w-full" data-help="ID of the first transaction">
                    <input type="number" id="id2" placeholder="Second transaction ID" class="border p-2 rounded w-full" data-help="ID of the matching transaction">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded" aria-label="Link selected transactions as transfer"><i class="fas fa-link inline w-4 h-4 mr-2"></i>Link</button>
                </form>
            </section>
        </main>
    </div>
    <script src="js/page_header.js"></script>
    <script>
const pageMain = document.querySelector('main.ops-main');
window.renderPageHeader(pageMain, {
    title: 'Detected Transfers',
    breadcrumb: 'Transactions / Data Quality',
    subtitle: "Manage possible transfers between accounts and mark them so they don't count toward income or outgoings.",
    actions: '<span class="space-x-2"><button id="assist-btn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm" aria-label="Assist with transfer matching"><i class="fas fa-magic inline w-4 h-4 mr-1"></i>Assist</button><button id="mark-all" class="bg-green-600 text-white px-3 py-1 rounded text-sm" aria-label="Mark all detected transfers"><i class="fas fa-check-double inline w-4 h-4 mr-1"></i>Mark All</button></span>'
});
</script>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script>

    let transfersTable = null;
    let linkedTable = null;
    const feedbackCard = document.getElementById('transfer-feedback');
    const feedbackText = document.getElementById('transfer-feedback-text');
    const assistButton = document.getElementById('assist-btn');
    const markAllButton = document.getElementById('mark-all');
    const undoAllButton = document.getElementById('undo-all');
    const linkForm = document.getElementById('link-form');

    function showFeedback(type, message){
        feedbackCard.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'bg-blue-50', 'text-green-800', 'text-red-800', 'text-blue-800');
        if(type === 'success'){
            feedbackCard.classList.add('bg-green-50', 'text-green-800');
        } else if(type === 'error') {
            feedbackCard.classList.add('bg-red-50', 'text-red-800');
        } else {
            feedbackCard.classList.add('bg-blue-50', 'text-blue-800');
        }
        feedbackText.textContent = message;
    }

    function setButtonBusy(button, isBusy, busyText, normalHtml){
        button.disabled = isBusy;
        button.classList.toggle('opacity-60', isBusy);
        button.classList.toggle('cursor-not-allowed', isBusy);
        button.innerHTML = isBusy ? `<i class="fas fa-spinner fa-spin inline w-4 h-4 mr-1"></i>${busyText}` : normalHtml;
    }

    function renderTransfers(data){
        if(transfersTable){
            transfersTable.setData(data);
            return;
        }
        transfersTable = tailwindTabulator(document.getElementById('transfers-table'), {
            data: data,
            layout: 'fitDataStretch',
            columns: [
                { title: 'Date', field: 'date' },
                { title: 'From Account', field: 'from_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.from_id}">${cell.getValue()}</a>`; } },
                { title: 'From Amount', field: 'from_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'From Description', field: 'from_description' },
                { title: 'To Account', field: 'to_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.to_id}">${cell.getValue()}</a>`; } },
                { title: 'To Amount', field: 'to_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'To Description', field: 'to_description' },
                { title: 'Mark', formatter: function(){ return '<button class="bg-green-600 text-white px-2 py-1 rounded text-sm"><i class="fas fa-check w-4 h-4"></i></button>'; }, width: 90, hozAlign: 'center', cellClick: function(e, cell){ const r = cell.getRow().getData(); markTransfers([[r.from_id, r.to_id]]); } }
            ]
        });
    }

    function markTransfers(pairs){
        return fetch('../php_backend/public/mark_transfer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pairs: pairs })
        })

        .then(resp => resp.json())
        .then(res => {
            if(res.status === 'ok') {
                loadCandidates();
                loadTransfers();
                showFeedback('success', `${pairs.length} transfer pair${pairs.length === 1 ? '' : 's'} marked successfully.`);
            } else {
                showFeedback('error', res.error || 'Failed to mark transfers.');
            }
        })
        .catch(() => {
            showFeedback('error', 'Unable to mark transfers due to a network or server error.');
        });
    }

    function renderLinked(data){
        if(linkedTable){
            linkedTable.setData(data);
            return;
        }
        linkedTable = tailwindTabulator(document.getElementById('linked-table'), {
            data: data,
            layout: 'fitDataStretch',
            columns: [
                { title: 'Date', field: 'date' },
                { title: 'From Account', field: 'from_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.from_id}">${cell.getValue()}</a>`; } },
                { title: 'From Amount', field: 'from_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'From Description', field: 'from_description' },
                { title: 'To Account', field: 'to_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.to_id}">${cell.getValue()}</a>`; } },
                { title: 'To Amount', field: 'to_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'To Description', field: 'to_description' },
                { title: 'Undo', formatter: function(){ return '<button class="bg-red-600 text-white px-2 py-1 rounded text-sm"><i class="fas fa-rotate-left w-4 h-4"></i></button>'; }, width: 90, hozAlign: 'center', cellClick: function(e, cell){ const r = cell.getRow().getData(); unmarkTransfers([r.from_id]); } }
            ]
        });
    }

    function loadTransfers(){
        fetch('../php_backend/public/transfers.php')
        .then(resp => resp.json())
        .then(res => {
            renderLinked(res.transfers || []);
        });
    }

    function unmarkTransfers(ids){
        return fetch('../php_backend/public/unmark_transfer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: ids })
        })
        .then(resp => resp.json())
        .then(res => {
            if(res.status === 'ok'){
                loadTransfers();
                loadCandidates();
                showFeedback('success', `${ids.length} transfer mark${ids.length === 1 ? '' : 's'} removed.`);
            } else {
                showFeedback('error', res.error || 'Failed to undo transfers.');
            }
        })
        .catch(() => {
            showFeedback('error', 'Unable to undo transfers due to a network or server error.');
        });
    }


    function loadCandidates(){

        setButtonBusy(assistButton, true, 'Assisting...', '<i class="fas fa-magic inline w-4 h-4 mr-1"></i>Assist');
        fetch('../php_backend/public/assist_transfers.php', { method: 'POST' })
        .then(resp => resp.json())
        .then(res => {
            if(res.status === 'ok') {

                renderTransfers(res.candidates);
                showFeedback('success', `Found ${res.candidates.length} possible transfer pair${res.candidates.length === 1 ? '' : 's'}.`);

            } else {
                showFeedback('error', res.error || 'Assist failed.');
            }
        })
        .catch(() => {
            showFeedback('error', 'Unable to fetch transfer suggestions due to a network or server error.');
        })
        .finally(() => {
            setButtonBusy(assistButton, false, 'Assisting...', '<i class="fas fa-magic inline w-4 h-4 mr-1"></i>Assist');
        });

    }

    assistButton.addEventListener('click', loadCandidates);

    markAllButton.addEventListener('click', function(){
        if(!transfersTable) return;
       const pairs = transfersTable.getData().map(r => [r.from_id, r.to_id]);
       if(pairs.length){
            setButtonBusy(markAllButton, true, 'Marking...', '<i class="fas fa-check-double inline w-4 h-4 mr-1"></i>Mark All');
            markTransfers(pairs).finally(() => {
                setButtonBusy(markAllButton, false, 'Marking...', '<i class="fas fa-check-double inline w-4 h-4 mr-1"></i>Mark All');
            });
        } else {
            showFeedback('info', 'There are no suggested transfers to mark right now. Click Assist to refresh suggestions.');
        }

    });
    undoAllButton.addEventListener('click', function(){
        if(!linkedTable) return;
        const ids = linkedTable.getData().map(r => r.from_id);
        if(ids.length){
            setButtonBusy(undoAllButton, true, 'Undoing...', '<i class="fas fa-rotate-left inline w-4 h-4 mr-1"></i>Undo All');
            unmarkTransfers(ids).finally(() => {
                setButtonBusy(undoAllButton, false, 'Undoing...', '<i class="fas fa-rotate-left inline w-4 h-4 mr-1"></i>Undo All');
            });
        } else {
            showFeedback('info', 'There are no marked transfers to undo.');
        }
    });

    linkForm.addEventListener('submit', function(e){
        e.preventDefault();
        const id1 = document.getElementById('id1').value;
        const id2 = document.getElementById('id2').value;
        const linkButton = linkForm.querySelector('button[type="submit"]');
        setButtonBusy(linkButton, true, 'Linking...', '<i class="fas fa-link inline w-4 h-4 mr-2"></i>Link');
        fetch('../php_backend/public/link_transfer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id1: id1, id2: id2 })
        })
        .then(resp => resp.json())
        .then(res => {
            if (res.status === 'ok') {
                showFeedback('success', 'Transfer link created successfully. Refreshing data...');
                loadTransfers();
                loadCandidates();
                linkForm.reset();
            } else {
                showFeedback('error', res.error || 'Failed to link transactions.');
            }
        })
        .catch(() => {
            showFeedback('error', 'Unable to link transactions due to a network or server error.');
        })
        .finally(() => {
            setButtonBusy(linkButton, false, 'Linking...', '<i class="fas fa-link inline w-4 h-4 mr-2"></i>Link');
        });
    });

    loadTransfers();
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Transfers</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = { darkMode: "class" };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_simple.min.css">

</head>
<body class="bg-gradient-to-b from-indigo-50 to-white font-sans dark:from-gray-900 dark:to-gray-800 dark:text-gray-100">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-white border-r p-6 overflow-y-auto dark:bg-gray-800 dark:border-gray-700"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6 space-y-6">
            <section>
                <h1 class="text-2xl font-semibold mb-4 flex items-center justify-between text-indigo-700">
                    Detected Transfers

                    <span class="space-x-2">
                        <button id="assist-btn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-magic inline w-4 h-4 mr-1"></i>Assist</button>
                        <button id="mark-all" class="bg-green-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-check-double inline w-4 h-4 mr-1"></i>Mark All</button>
                    </span>

                </h1>
                <p class="mb-4">Manage possible transfers between accounts and mark them so they don't count toward income or outgoings.</p>
                <div id="transfers-table"></div>
            </section>
            <section>
                <h2 class="text-xl font-semibold mb-4 flex items-center justify-between">
                    Marked Transfers
                    <button id="undo-all" class="bg-red-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-rotate-left inline w-4 h-4 mr-1"></i>Undo All</button>
                </h2>
                <div id="linked-table"></div>
            </section>
            <section>
                <h2 class="text-xl font-semibold mb-4">Link Transactions as Transfer</h2>
                <form id="link-form" class="space-y-4">
                    <input type="number" id="id1" placeholder="First transaction ID" class="border p-2 rounded w-full" data-help="ID of the first transaction">
                    <input type="number" id="id2" placeholder="Second transaction ID" class="border p-2 rounded w-full" data-help="ID of the matching transaction">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded"><i class="fas fa-link inline w-4 h-4 mr-2"></i>Link</button>
                </form>
            </section>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script>

    let transfersTable = null;
    let linkedTable = null;

    function renderTransfers(data){
        if(transfersTable){
            transfersTable.setData(data);
            return;
        }
        transfersTable = tailwindTabulator(document.getElementById('transfers-table'), {
            data: data,
            layout: 'fitDataStretch',
            columns: [
                { title: 'Date', field: 'date' },
                { title: 'From Account', field: 'from_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.from_id}">${cell.getValue()}</a>`; } },
                { title: 'From Amount', field: 'from_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'From Description', field: 'from_description' },
                { title: 'To Account', field: 'to_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.to_id}">${cell.getValue()}</a>`; } },
                { title: 'To Amount', field: 'to_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'To Description', field: 'to_description' },
                { title: 'Mark', formatter: function(){ return '<button class="bg-green-600 text-white px-2 py-1 rounded text-sm"><i class="fas fa-check w-4 h-4"></i></button>'; }, width: 90, hozAlign: 'center', cellClick: function(e, cell){ const r = cell.getRow().getData(); markTransfers([[r.from_id, r.to_id]]); } }
            ]
        });
    }

    function markTransfers(pairs){
        fetch('../php_backend/public/mark_transfer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pairs: pairs })
        })

        .then(resp => resp.json())
        .then(res => {
            if(res.status === 'ok') {
                loadCandidates();
                loadTransfers();
            } else {
                alert(res.error || 'Failed to mark transfers');
            }
        });
    }

    function renderLinked(data){
        if(linkedTable){
            linkedTable.setData(data);
            return;
        }
        linkedTable = tailwindTabulator(document.getElementById('linked-table'), {
            data: data,
            layout: 'fitDataStretch',
            columns: [
                { title: 'Date', field: 'date' },
                { title: 'From Account', field: 'from_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.from_id}">${cell.getValue()}</a>`; } },
                { title: 'From Amount', field: 'from_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'From Description', field: 'from_description' },
                { title: 'To Account', field: 'to_account', formatter: function(cell){ const row = cell.getRow().getData(); return `<a href="transaction.html?id=${row.to_id}">${cell.getValue()}</a>`; } },
                { title: 'To Amount', field: 'to_amount', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right' },
                { title: 'To Description', field: 'to_description' },
                { title: 'Undo', formatter: function(){ return '<button class="bg-red-600 text-white px-2 py-1 rounded text-sm"><i class="fas fa-rotate-left w-4 h-4"></i></button>'; }, width: 90, hozAlign: 'center', cellClick: function(e, cell){ const r = cell.getRow().getData(); unmarkTransfers([r.from_id]); } }
            ]
        });
    }

    function loadTransfers(){
        fetch('../php_backend/public/transfers.php')
        .then(resp => resp.json())
        .then(res => {
            renderLinked(res.transfers || []);
        });
    }

    function unmarkTransfers(ids){
        fetch('../php_backend/public/unmark_transfer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: ids })
        })
        .then(resp => resp.json())
        .then(res => {
            if(res.status === 'ok'){
                loadTransfers();
                loadCandidates();
            } else {
                alert(res.error || 'Failed to undo transfers');
            }
        });
    }


    function loadCandidates(){

        fetch('../php_backend/public/assist_transfers.php', { method: 'POST' })
        .then(resp => resp.json())
        .then(res => {
            if(res.status === 'ok') {

                renderTransfers(res.candidates);

            } else {
                alert(res.error || 'Assist failed');
            }
        });

    }

    document.getElementById('assist-btn').addEventListener('click', loadCandidates);

    document.getElementById('mark-all').addEventListener('click', function(){
        if(!transfersTable) return;
       const pairs = transfersTable.getData().map(r => [r.from_id, r.to_id]);
       if(pairs.length){ markTransfers(pairs); }

    });
    document.getElementById('undo-all').addEventListener('click', function(){
        if(!linkedTable) return;
        const ids = linkedTable.getData().map(r => r.from_id);
        if(ids.length){ unmarkTransfers(ids); }
    });

    document.getElementById('link-form').addEventListener('submit', function(e){
        e.preventDefault();
        const id1 = document.getElementById('id1').value;
        const id2 = document.getElementById('id2').value;
        fetch('../php_backend/public/link_transfer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id1: id1, id2: id2 })
        })
        .then(resp => resp.json())
        .then(res => {
            if (res.status === 'ok') {
                location.reload();
            } else {
                alert(res.error || 'Failed to link transactions');
            }
        });
    });

    loadTransfers();
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

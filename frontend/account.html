<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Balance</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {};
    </script>

    <script src="https://cdn.tailwindcss.com"></script>


    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_simple.min.css">

</head>
<body class="bg-gradient-to-b from-indigo-50 to-white font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-white border-r p-6 overflow-y-auto"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6">
            <h1 id="account-name" class="text-2xl font-semibold mb-4 text-indigo-700">Account Balance</h1>
            <p id="account-details" class="mb-4 text-gray-600"></p>
            <p class="mb-4">View the balance over time based on the latest bank statement.</p>
            <div class="bg-white p-6 rounded shadow border border-gray-400">
                <div id="balance-chart" style="height:400px" data-chart-desc="Line chart of account balance over time."></div>
            </div>

            <div class="bg-white p-6 rounded shadow border border-gray-400 mt-6">
                <div id="statement-table"></div>
            </div>

        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="js/color_map.js"></script>
    <script>
    function balanceTooltip(){
        const prev = this.point.index > 0 ? this.series.yData[this.point.index - 1] : null;
        let text = `Date: ${this.category}<br/>Balance: £${Highcharts.numberFormat(this.y, 2)}`;
        if(prev !== null){
            const delta = this.y - prev;
            text += `<br/>Change: £${Highcharts.numberFormat(delta, 2)}`;
        }
        return text;
    }
    // Format balance cells with currency and positive/negative colouring
    function balanceFormatter(cell){
        const value = cell.getValue();
        const el = cell.getElement();
        el.classList.toggle('text-red-600', value < 0);
        el.classList.toggle('text-green-600', value > 0);
        return '£' + parseFloat(value).toFixed(2);
    }


    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (id) {
        fetch(`../php_backend/public/account_balance.php?id=${id}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('balance-chart').textContent = 'Account not found.';
                    return;
                }
                document.getElementById('account-name').textContent = data.name;
                const details = data.sort_code ? `Sort Code: ${data.sort_code}  Account Number: ${data.account_number}` : `Card Number: ${data.account_number}`;
                document.getElementById('account-details').textContent = details;
                const dates = data.history.map(h => h.date);
                const balances = data.history.map(h => parseFloat(h.balance));
                Highcharts.chart('balance-chart', {
                    colors: chartColors,
                    title: { text: 'Balance Over Time' },
                    xAxis: { categories: dates },
                    yAxis: { title: { text: 'Balance (£)' }, labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } } },
                    tooltip: { pointFormatter: balanceTooltip },
                    series: [{ name: 'Balance', data: balances, colorByPoint: true }]
                });
            });


        fetch(`../php_backend/public/account_statement.php?id=${id}`)
            .then(r => r.json())
            .then(rows => {
                tailwindTabulator(document.getElementById('statement-table'), {
                    data: rows,
                    layout: 'fitDataStretch',
                    rowClick: (e, row) => {
                        window.location = `transaction.html?id=${row.getData().id}`;
                    },
                    columns: [
                        { title: 'Date', field: 'date' },
                        { title: 'Description', field: 'description' },
                        { title: 'Amount', field: 'amount', hozAlign: 'right', formatter: balanceFormatter }
                    ]
                });
            });

    } else {
        document.getElementById('balance-chart').textContent = 'No account specified.';
    }
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

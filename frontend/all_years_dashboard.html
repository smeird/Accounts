<!DOCTYPE html>
<!-- Dashboard showing totals across all years -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Years Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css">
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="w-64 bg-white border-r p-6"></nav>
        <main class="flex-1 p-6">
            <h1 class="text-2xl font-semibold mb-4">All Years Dashboard</h1>

            <h2 class="text-xl font-semibold mt-6 mb-2">Tag Totals</h2>
            <div id="tags-table" class="mt-2"></div>
            <div id="tags-chart" class="mt-4" style="height:400px"></div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Category Totals</h2>
            <div id="categories-table" class="mt-2"></div>
            <div id="categories-chart" class="mt-4" style="height:400px"></div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Category & Tag Breakdown</h2>
            <div id="category-tag-donut" class="mt-2" style="height:400px"></div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Group Totals</h2>
            <div id="groups-table" class="mt-2"></div>
            <div id="groups-chart" class="mt-4" style="height:400px"></div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
    function totalFormatter(cell){
        const value = cell.getValue();
        const el = cell.getElement();
        el.classList.toggle('text-red-600', value < 0);
        el.classList.toggle('text-green-600', value > 0);
        return '£' + parseFloat(value).toFixed(2);
    }

    function buildTable(id, data, years){
        const el = document.getElementById(id);
        el.innerHTML = '';

        const yearCols = years.map(y => ({
            title: y,
            field: String(y),
            formatter: 'money',
            formatterParams: { symbol: '£', precision: 2 },
            hozAlign: 'right',
            bottomCalc: 'sum',
            bottomCalcFormatter: totalFormatter
        }));

        const columns = [
            { title: 'Name', field: 'name', bottomCalc: () => 'Total' },
            ...yearCols,
            { title: 'Total', field: 'total', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right', bottomCalc: 'sum', bottomCalcFormatter: totalFormatter }
        ];

        tailwindTabulator(el, {
            data: data,
            layout: 'fitColumns',
            columns: columns
        });
    }

    function buildChart(id, title, data){
        Highcharts.chart(id, {
            chart: { type: 'column' },
            title: { text: title },
            xAxis: { categories: data.map(d => d.name) },
            yAxis: { title: { text: 'Amount (£)' }, labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value, 2); } } },
            tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
            series: [{ name: 'Total', data: data.map(d => parseFloat(d.total)) }]
        });
    }

    function buildDonutChart(id, categories, tags){

        const colors = Highcharts.getOptions().colors;
        const categoryData = [];
        const tagData = [];

        categories.forEach((c, i) => {
            const color = colors[i % colors.length];
            categoryData.push({ name: c.name, y: parseFloat(c.total), color });

            tags.filter(t => t.category === c.name).forEach(t => {
                tagData.push({
                    name: t.name,
                    y: parseFloat(t.total),
                    color: Highcharts.color(color).brighten(0.1).get()
                });
            });
        });


        Highcharts.chart(id, {
            chart: { type: 'pie' },
            title: { text: 'Categories and Tags' },
            tooltip: { pointFormatter: function(){ return '£' + Highcharts.numberFormat(this.y, 2); } },
            plotOptions: {
                pie: {
                    dataLabels: {
                        formatter: function(){ return this.point.name + ': £' + Highcharts.numberFormat(this.y, 2); }
                    }
                }
            },
            series: [

                { name: 'Categories', data: categoryData, size: '60%', dataLabels: { distance: -30 } },
                { name: 'Tags', data: tagData, size: '80%', innerSize: '60%' }

            ]
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetch('../php_backend/public/all_years_dashboard.php')
            .then(resp => resp.json())
            .then(data => {
                buildTable('tags-table', data.tags, data.years);
                buildChart('tags-chart', 'Tag Totals', data.tags);
                buildTable('categories-table', data.categories, data.years);
                buildChart('categories-chart', 'Category Totals', data.categories);
                buildDonutChart('category-tag-donut', data.categories, data.tags);
                buildTable('groups-table', data.groups, data.years);
                buildChart('groups-chart', 'Group Totals', data.groups);
            });
    });
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

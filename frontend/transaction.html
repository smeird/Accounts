<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Transaction Details</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = { darkMode: "class" };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome icons loaded via menu.js -->
</head>
<body class="bg-gradient-to-b from-indigo-50 to-white font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-white border-r p-6 overflow-y-auto"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6">
            <h1 class="text-2xl font-semibold mb-4 text-indigo-700">Transaction Details</h1>
            <p class="mb-4">Review or edit the information for a single transaction. Changes here immediately update dashboards, reports and budgets.</p>
            <div id="transaction-details" class="mt-4"></div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const container = document.getElementById('transaction-details');
    if (!id) {
        container.textContent = 'No transaction id provided.';
    } else {
        Promise.all([
            fetch('../php_backend/public/transaction.php?id=' + id).then(r => r.json()),
            fetch('../php_backend/public/groups.php').then(r => r.json())
        ]).then(([tx, groups]) => {
            if (tx.error) {
                container.textContent = 'Transaction not found.';
                return;
            }

            const card = document.createElement('div');
            card.className = 'relative bg-white p-6 rounded shadow border border-gray-400';

            function createBadge(text, colorClasses) {
                const span = document.createElement('span');
                span.textContent = text;
                span.className = `inline-block px-2 py-1 text-xs font-semibold rounded ${colorClasses}`;
                return span;
            }

            const badges = document.createElement('div');
            badges.className = 'absolute top-2 right-2 flex flex-col space-y-2 items-end';

            function addBadge(value, color) {
                if (!value) return;
                const link = document.createElement('a');
                link.href = `search.html?value=${encodeURIComponent(value)}`;
                link.appendChild(createBadge(value, color));
                badges.appendChild(link);
            }

            addBadge(tx.tag_name, 'bg-indigo-200 text-indigo-800');
            addBadge(tx.category_name, 'bg-green-200 text-green-800');
            addBadge(tx.segment_name, 'bg-yellow-200 text-yellow-800');

            card.appendChild(badges);

            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex"><dt class="font-semibold w-40">Transaction ID</dt><dd>${tx.id}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Account</dt><dd>${tx.account_name || ''}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Sort Code</dt><dd>${tx.sort_code || ''}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Account Number</dt><dd>${tx.account_number || ''}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Date</dt><dd>${tx.date}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Description</dt><dd>${tx.description}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Memo</dt><dd>${tx.memo || ''}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Amount</dt><dd>£${parseFloat(tx.amount).toFixed(2)}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">OFX Type</dt><dd>${tx.ofx_type || ''}</dd></div>
                    ${tx.ofx_id ? `<div class="flex"><dt class="font-semibold w-40">OFX ID</dt><dd>${tx.ofx_id}</dd></div>` : ''}
                    ${tx.bank_ofx_id ? `<div class="flex"><dt class="font-semibold w-40">Bank OFX ID</dt><dd>${tx.bank_ofx_id}</dd></div>` : ''}
                    <div class="flex"><dt class="font-semibold w-40">Transfer</dt><dd>${tx.transfer_id ? '<span class="text-blue-600"><i class="fas fa-right-left inline w-4 h-4 mr-1"></i>Yes – ignored in KPI, income and expense totals (ID ' + tx.transfer_id + ')</span>' : 'No'}</dd></div>
                    <div class="flex"><dt class="font-semibold w-40">Category</dt><dd>${tx.category_name || 'None'}</dd></div>
                </dl>
                <label class="block">Tag: <input type="text" id="tag" class="border p-2 rounded w-full" data-help="Enter a new tag name to auto-tag similar transactions"></label>
                <label class="block">Group: <select id="group" class="border p-2 rounded w-full" data-help="Assign a group"></select></label>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Save</button>
            `;
            card.appendChild(form);
            container.appendChild(card);
            const tagInput = form.querySelector('#tag');
            if (tx.tag_name) {
                tagInput.parentElement.classList.add('hidden');
            }
            const groupSel = form.querySelector('#group');
            tagInput.value = tx.tag_name || '';
            const blankGrp = document.createElement('option');
            blankGrp.value = '';
            blankGrp.textContent = '-- None --';
            groupSel.appendChild(blankGrp);
            groups.forEach(g => {
                if (g.active || g.id == tx.group_id) {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    if (g.id == tx.group_id) opt.selected = true;
                    else if (!g.active) opt.disabled = true;
                    groupSel.appendChild(opt);
                }
            });
            const newGrp = document.createElement('option');
            newGrp.value = '__new';
            newGrp.textContent = 'Add New Group...';
            groupSel.appendChild(newGrp);

            groupSel.addEventListener('change', () => {
                if (groupSel.value === '__new') {
                    const name = prompt('Enter new group name:');
                    if (!name) { groupSel.value = ''; return; }
                    fetch('../php_backend/public/groups.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    }).then(r => r.json()).then(res => {
                        if (res.id) {
                            const opt = document.createElement('option');
                            opt.value = res.id;
                            opt.textContent = name;
                            groupSel.insertBefore(opt, newGrp);
                            groupSel.value = res.id;
                            showMessage('Group created');
                        } else {
                            alert('Failed to create group');
                            groupSel.value = '';
                        }
                    }).catch(() => {
                        alert('Failed to create group');
                        groupSel.value = '';
                    });
                }
            });

            form.addEventListener('submit', function(ev){
                ev.preventDefault();
                const payload = {
                    transaction_id: tx.id,
                    account_id: tx.account_id,
                    description: tx.description
                };
                if (groupSel.value !== '') payload.group_id = groupSel.value;
                if (tagInput.value.trim() !== '') payload.tag_name = tagInput.value.trim();

                fetch('../php_backend/public/update_transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(res => {
                    if (res && res.status === 'ok') {
                        showMessage('Saved');
                        setTimeout(() => {
                            if (document.referrer) {
                                window.location = document.referrer;
                            } else {
                                history.back();
                            }
                        }, 500);
                    } else {
                        alert('Failed to save');
                    }
                }).catch(() => alert('Failed to save'));
            });
        });
    }
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

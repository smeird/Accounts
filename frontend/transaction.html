<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Transaction Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="w-64 flex-shrink-0 bg-white border-r p-6"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6">
            <h1 class="text-2xl font-semibold mb-4">Transaction Details</h1>
            <p class="mb-4">Review or edit the information for a single transaction.</p>
            <div id="transaction-details" class="mt-4"></div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const container = document.getElementById('transaction-details');
    if (!id) {
        container.textContent = 'No transaction id provided.';
    } else {
        Promise.all([
            fetch('../php_backend/public/transaction.php?id=' + id).then(r => r.json()),
            fetch('../php_backend/public/groups.php').then(r => r.json())
        ]).then(([tx, groups]) => {
            if (tx.error) {
                container.textContent = 'Transaction not found.';
                return;
            }

            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <p><strong>Date:</strong> ${tx.date}</p>
                <p><strong>Description:</strong> ${tx.description}</p>
                <p><strong>Memo:</strong> ${tx.memo || ''}</p>
                <p><strong>Amount:</strong> Â£${parseFloat(tx.amount).toFixed(2)}</p>
                <p><strong>OFX Type:</strong> ${tx.ofx_type || ''}</p>
                ${tx.category_name ? '<p><strong>Category:</strong> ' + tx.category_name + '</p>' : ''}
                <label class="block">Tag: <input type="text" id="tag" class="border p-2 rounded w-full" data-help="Enter a new tag name to auto-tag similar transactions"></label>
                <label class="block">Group: <select id="group" class="border p-2 rounded w-full" data-help="Assign a group"></select></label>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
            `;
            container.appendChild(form);
            const tagInput = form.querySelector('#tag');
            const groupSel = form.querySelector('#group');
            const blankGrp = document.createElement('option');
            blankGrp.value = '';
            blankGrp.textContent = '-- None --';
            groupSel.appendChild(blankGrp);
            groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = g.name;
                if (g.id == tx.group_id) opt.selected = true;
                groupSel.appendChild(opt);
            });
            const newGrp = document.createElement('option');
            newGrp.value = '__new';
            newGrp.textContent = 'Add New Group...';
            groupSel.appendChild(newGrp);

            groupSel.addEventListener('change', () => {
                if (groupSel.value === '__new') {
                    const name = prompt('Enter new group name:');
                    if (!name) { groupSel.value = ''; return; }
                    fetch('../php_backend/public/groups.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    }).then(r => r.json()).then(res => {
                        if (res.id) {
                            const opt = document.createElement('option');
                            opt.value = res.id;
                            opt.textContent = name;
                            groupSel.insertBefore(opt, newGrp);
                            groupSel.value = res.id;
                            showMessage('Group created');
                        } else {
                            alert('Failed to create group');
                            groupSel.value = '';
                        }
                    }).catch(() => {
                        alert('Failed to create group');
                        groupSel.value = '';
                    });
                }
            });

            form.addEventListener('submit', function(ev){
                ev.preventDefault();
                const payload = {
                    transaction_id: tx.id,
                    account_id: tx.account_id,
                    description: tx.description
                };
                if (groupSel.value !== '') payload.group_id = groupSel.value;
                if (tagInput.value.trim() !== '') payload.tag_name = tagInput.value.trim();

                fetch('../php_backend/public/update_transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(res => {
                    if (res && res.status === 'ok') {
                        showMessage('Saved');
                        setTimeout(() => {
                            if (document.referrer) {
                                window.location = document.referrer;
                            } else {
                                history.back();
                            }
                        }, 500);
                    } else {
                        alert('Failed to save');
                    }
                }).catch(() => alert('Failed to save'));
            });
        });
    }
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Transaction Details</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {};
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome icons loaded via menu.js -->
    <style>
    @media print {
        body { background: white; }
        nav, h1, p, .no-print { display: none !important; }
        .receipt { border: none; box-shadow: none; }
    }
    </style>
</head>
<body class="bg-gradient-to-b from-indigo-50 to-white">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-transparent p-6 overflow-y-auto"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6">
            <h1 class="text-2xl font-semibold mb-4 text-indigo-700">Transaction Details</h1>
            <p class="mb-4">Review or edit the information for a single transaction. Changes here immediately update dashboards, reports and budgets.</p>
            <div id="transaction-details" class="mt-4"></div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const container = document.getElementById('transaction-details');
    if (!id) {
        container.textContent = 'No transaction id provided.';
    } else {
        Promise.all([
            fetch('../php_backend/public/transaction.php?id=' + id).then(r => r.json()),
            fetch('../php_backend/public/groups.php').then(r => r.json()),
            fetch('../php_backend/public/categories.php').then(r => r.json())
        ]).then(([tx, groups, categories]) => {
            if (tx.error) {
                container.textContent = 'Transaction not found.';
                return;
            }

            const card = document.createElement('div');
            card.className = 'relative bg-white p-6 rounded shadow';

            function createBadge(text, colorClasses) {
                const span = document.createElement('span');
                span.textContent = text;
                span.className = `inline-block px-2 py-1 text-xs font-semibold rounded ${colorClasses}`;
                return span;
            }

            const badges = document.createElement('div');
            badges.className = 'absolute top-2 right-2 flex flex-col space-y-2 items-end';

            function addBadge(value, color) {
                if (!value) return;
                const link = document.createElement('a');
                link.href = `search.html?value=${encodeURIComponent(value)}`;
                link.appendChild(createBadge(value, color));
                badges.appendChild(link);
            }

            addBadge(tx.tag_name, 'bg-indigo-200 text-indigo-800');
            addBadge(tx.category_name, 'bg-green-200 text-green-800');
            addBadge(tx.segment_name, 'bg-yellow-200 text-yellow-800');

            card.appendChild(badges);

            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <div class="receipt font-mono text-sm max-w-xs mx-auto border border-dashed p-4 space-y-1">
                    <div class="flex justify-between"><span class="font-semibold">Transaction ID</span><span>${tx.id}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Account</span><span>${tx.account_name || ''}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Sort Code</span><span>${tx.sort_code || ''}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Account Number</span><span>${tx.account_number || ''}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Date</span><span>${tx.date}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Description</span><span>${tx.description}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Memo</span><span>${tx.memo || ''}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Amount</span><span>£${parseFloat(tx.amount).toFixed(2)}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">OFX Type</span><span>${tx.ofx_type || ''}</span></div>
                    ${tx.ofx_id ? `<div class="flex justify-between"><span class="font-semibold">OFX ID</span><span>${tx.ofx_id}</span></div>` : ''}
                    ${tx.bank_ofx_id ? `<div class="flex justify-between"><span class="font-semibold">Bank OFX ID</span><span>${tx.bank_ofx_id}</span></div>` : ''}
                    <div class="flex justify-between"><span class="font-semibold">Transfer</span><span>${tx.transfer_id ? '<span class="text-blue-600"><i class="fas fa-right-left inline w-4 h-4 mr-1"></i>Yes – ignored in KPI, income and expense totals (ID ' + tx.transfer_id + ')</span>' : 'No'}</span></div>
                    <div class="flex justify-between"><span class="font-semibold">Category</span><span>${tx.category_name || 'None'}</span></div>
                </div>
                <label class="block">Tag: <input type="text" id="tag" class="border p-2 rounded w-full" data-help="Enter a new tag name to auto-tag similar transactions"></label>
                <label class="block">Category Group: <select id="category" class="border p-2 rounded w-full" data-help="Assign a category group"></select></label>
                <label class="block">Group: <select id="group" class="border p-2 rounded w-full" data-help="Assign a group"></select></label>
                <div class="flex space-x-2 justify-center no-print">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded" aria-label="Save transaction">Save</button>
                    <button type="button" id="print" class="bg-gray-600 text-white px-4 py-2 rounded" aria-label="Print receipt">Print Receipt</button>
                </div>
            `;
            card.appendChild(form);
            container.appendChild(card);
            const printBtn = form.querySelector('#print');
            if (printBtn) {
                printBtn.addEventListener('click', () => window.print());
            }
            const tagInput = form.querySelector('#tag');
            if (tx.tag_name) {
                tagInput.parentElement.classList.add('hidden');
            }
            const groupSel = form.querySelector('#group');
            const catSel = form.querySelector('#category');
            tagInput.value = tx.tag_name || '';
            const blankGrp = document.createElement('option');
            blankGrp.value = '';
            blankGrp.textContent = '-- None --';
            groupSel.appendChild(blankGrp);
            groups.forEach(g => {
                if (g.active || g.id == tx.group_id) {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    if (g.id == tx.group_id) opt.selected = true;
                    else if (!g.active) opt.disabled = true;
                    groupSel.appendChild(opt);
                }
            });
            const blankCat = document.createElement('option');
            blankCat.value = '';
            blankCat.textContent = '-- None --';
            catSel.appendChild(blankCat);
            const segMap = {};
            categories.forEach(c => {
                const seg = c.segment_name || 'Unassigned';
                if (!segMap[seg]) {
                    const og = document.createElement('optgroup');
                    og.label = seg;
                    segMap[seg] = og;
                    catSel.appendChild(og);
                }
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                if (c.id == tx.category_id) opt.selected = true;
                segMap[seg].appendChild(opt);
            });
            const newGrp = document.createElement('option');
            newGrp.value = '__new';
            newGrp.textContent = 'Add New Group...';
            groupSel.appendChild(newGrp);

            groupSel.addEventListener('change', () => {
                if (groupSel.value === '__new') {
                    const name = prompt('Enter new group name:');
                    if (!name) { groupSel.value = ''; return; }
                    fetch('../php_backend/public/groups.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    }).then(r => r.json()).then(res => {
                        if (res.id) {
                            const opt = document.createElement('option');
                            opt.value = res.id;
                            opt.textContent = name;
                            groupSel.insertBefore(opt, newGrp);
                            groupSel.value = res.id;
                            showMessage('Group created');
                        } else {
                            alert('Failed to create group');
                            groupSel.value = '';
                        }
                    }).catch(() => {
                        alert('Failed to create group');
                        groupSel.value = '';
                    });
                }
            });

            form.addEventListener('submit', function(ev){
                ev.preventDefault();
                const payload = {
                    transaction_id: tx.id,
                    account_id: tx.account_id,
                    description: tx.description
                };
                if (groupSel.value !== '') payload.group_id = groupSel.value;
                if (catSel.value !== '') payload.category_id = catSel.value;
                if (tx.tag_id) payload.tag_id = tx.tag_id;
                else if (tagInput.value.trim() !== '') payload.tag_name = tagInput.value.trim();

                fetch('../php_backend/public/update_transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(res => {
                    if (res && res.status === 'ok') {
                        showMessage('Saved');
                        setTimeout(() => {
                            if (document.referrer) {
                                window.location = document.referrer;
                            } else {
                                history.back();
                            }
                        }, 500);
                    } else {
                        alert('Failed to save');
                    }
                }).catch(() => alert('Failed to save'));
            });
        });
    }
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
        <nav id="menu" class="w-64 bg-white border-r p-6"></nav>
        <main class="flex-1 p-6">
            <h1 class="text-2xl font-semibold mb-4">Transaction Details</h1>
            <p class="mb-4">Review or edit the information for a single transaction.</p>
            <div id="transaction-details" class="mt-4"></div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const container = document.getElementById('transaction-details');
    if (!id) {
        container.textContent = 'No transaction id provided.';
    } else {
        Promise.all([
            fetch('../php_backend/public/transaction.php?id=' + id).then(r => r.json()),
            fetch('../php_backend/public/categories.php').then(r => r.json()),
            fetch('../php_backend/public/tags.php').then(r => r.json()),
            fetch('../php_backend/public/groups.php').then(r => r.json())
        ]).then(([tx, categories, tags, groups]) => {
            if (tx.error) {
                container.textContent = 'Transaction not found.';
                return;
            }

            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <p><strong>Date:</strong> ${tx.date}</p>
                <p><strong>Description:</strong> ${tx.description}</p>
                <p><strong>Memo:</strong> ${tx.memo || ''}</p>
                <p><strong>Amount:</strong> Â£${parseFloat(tx.amount).toFixed(2)}</p>
                <label class="block">Category: <select id="category" class="border p-2 rounded w-full" data-help="Assign a category"></select></label>
                <label class="block">Tag: <select id="tag" class="border p-2 rounded w-full" data-help="Assign a tag"></select></label>
                <label class="block">Group: <select id="group" class="border p-2 rounded w-full" data-help="Assign a group"></select></label>
                <div class="flex space-x-2">
                    <button type="button" id="auto-tag-btn" class="bg-green-600 text-white px-4 py-2 rounded"><i class="fa-solid fa-tag mr-2"></i>Auto Tag</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
                </div>
            `;
            container.appendChild(form);

            const catSel = form.querySelector('#category');
            const blankCat = document.createElement('option');
            blankCat.value = '';
            blankCat.textContent = '-- None --';
            catSel.appendChild(blankCat);
            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                if (c.id == tx.category_id) opt.selected = true;
                catSel.appendChild(opt);
            });

            const tagSel = form.querySelector('#tag');
            const blankTag = document.createElement('option');
            blankTag.value = '';
            blankTag.textContent = '-- None --';
            tagSel.appendChild(blankTag);
            tags.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                if (t.id == tx.tag_id) opt.selected = true;
                tagSel.appendChild(opt);
            });
            const newOpt = document.createElement('option');
            newOpt.value = '__new';
            newOpt.textContent = 'Add New Tag...';
            tagSel.appendChild(newOpt);

            const groupSel = form.querySelector('#group');
            const blankGrp = document.createElement('option');
            blankGrp.value = '';
            blankGrp.textContent = '-- None --';
            groupSel.appendChild(blankGrp);
            groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = g.name;
                if (g.id == tx.group_id) opt.selected = true;
                groupSel.appendChild(opt);
            });

            const autoBtn = form.querySelector('#auto-tag-btn');
            autoBtn.addEventListener('click', async () => {
                const name = prompt('Tag Name', tx.description);
                if (!name) return;
                try {
                    const res = await fetch('../php_backend/public/tags.php', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({name: name, keyword: tx.description})
                    });
                    const info = await res.json();
                    if (info && info.id) {
                        const opt = document.createElement('option');
                        opt.value = info.id;
                        opt.textContent = name;
                        tagSel.insertBefore(opt, newOpt);
                        tagSel.value = info.id;
                        const payload = {
                            transaction_id: tx.id,
                            account_id: tx.account_id,
                            description: tx.description,
                            tag_id: info.id
                        };
                        if (catSel.value !== '') payload.category_id = catSel.value;
                        if (groupSel.value !== '') payload.group_id = groupSel.value;
                        await fetch('../php_backend/public/update_transaction.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        showMessage('Auto tag created');
                    } else {
                        alert('Failed to create tag');
                    }
                } catch (err) {
                    alert('Failed to create tag');
                }
            });

            form.addEventListener('submit', function(ev){
                ev.preventDefault();
                const payload = {
                    transaction_id: tx.id,
                    account_id: tx.account_id,
                    description: tx.description
                };
                if (catSel.value !== '') payload.category_id = catSel.value;
                if (groupSel.value !== '') payload.group_id = groupSel.value;
                if (tagSel.value === '__new') {
                    const name = prompt('Enter new tag name:');
                    if (!name) return;
                    payload.tag_name = name;
                } else if (tagSel.value !== '') {
                    payload.tag_id = tagSel.value;
                }

                fetch('../php_backend/public/update_transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(res => {
                    if (res && res.status === 'ok') {
                        showMessage('Saved');
                    } else {
                        alert('Failed to save');
                    }
                }).catch(() => alert('Failed to save'));
            });
        });
    }
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

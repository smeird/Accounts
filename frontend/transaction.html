<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Transaction Details</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {};
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="operational_ui.css">
    <!-- Font Awesome icons loaded via menu.js -->
    <style>
    .receipt-paper {
        position: relative;
        background: linear-gradient(180deg, #fffef9 0%, #fffdf4 100%);
        border: 1px solid #e5dcc2;
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.14), inset 0 0 0 1px rgba(255, 255, 255, 0.7);
    }
    .receipt-paper::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: -10px;
        height: 10px;
        background: repeating-linear-gradient(-45deg, #ede3c9 0 8px, #fffdf4 8px 16px);
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
    }
    .meta-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.28rem 0.65rem;
        font-size: 0.72rem;
        font-weight: 600;
        border-radius: 9999px;
        border: 1px solid transparent;
    }
    .meta-pill i { font-size: 0.7rem; }
    @media print {
        body { background: white; }
        nav, h1, p, .no-print { display: none !important; }
        .receipt-paper { border: none; box-shadow: none; }
        .receipt-paper::after { display: none; }
    }
    </style>
</head>
<body class="ops-body">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-transparent p-6 overflow-y-auto"></nav>
        <main class="ops-main flex-1 min-w-0 overflow-x-auto">
<div id="transaction-details" class="mt-4"></div>
        </main>
    </div>
    <script src="js/page_header.js"></script>
    <script>
const pageMain = document.querySelector('main.ops-main');
window.renderPageHeader(pageMain, {
    title: 'Transaction Details',
    breadcrumb: 'Transactions',
    subtitle: 'Review or edit the information for a single transaction. Changes here immediately update dashboards, reports and budgets.'
});
</script>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const container = document.getElementById('transaction-details');
    if (!id) {
        container.textContent = 'No transaction id provided.';
    } else {
        Promise.all([
            fetch('../php_backend/public/transaction.php?id=' + id).then(r => r.json()),
            fetch('../php_backend/public/groups.php').then(r => r.json()),
            fetch('../php_backend/public/categories.php').then(r => r.json())
        ]).then(([tx, groups, categories]) => {
            if (tx.error) {
                container.textContent = 'Transaction not found.';
                return;
            }

            const card = document.createElement('div');
            card.className = 'cards cards-tight';

            function createMetaPill(icon, label, value, colorClasses) {
                const link = document.createElement('a');
                link.href = `search.html?value=${encodeURIComponent(value)}`;
                link.className = `meta-pill ${colorClasses}`;
                link.setAttribute('aria-label', `Search for ${label} ${value}`);
                link.innerHTML = `<i class="fas ${icon}" aria-hidden="true"></i><span>${value}</span>`;
                return link;
            }

            const metaChips = document.createElement('div');
            metaChips.className = 'flex flex-wrap gap-2';

            function addMetaPill(icon, label, value, color) {
                if (!value) return;
                metaChips.appendChild(createMetaPill(icon, label, value, color));
            }

            addMetaPill('fa-tag', 'tag', tx.tag_name, 'bg-indigo-50 text-indigo-700 border-indigo-200');
            addMetaPill('fa-folder-open', 'category', tx.category_name, 'bg-emerald-50 text-emerald-700 border-emerald-200');
            addMetaPill('fa-diagram-project', 'segment', tx.segment_name, 'bg-amber-50 text-amber-700 border-amber-200');

            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.innerHTML = `
                <div class="receipt-paper max-w-xl mx-auto p-6 sm:p-8 space-y-4 text-slate-700">
                    <div class="text-center border-b border-dashed border-amber-300 pb-3">
                        <p class="uppercase tracking-[0.25em] text-xs text-slate-500">Transaction receipt</p>
                        <p class="text-sm text-slate-500">Reference #${tx.id}</p>
                    </div>
                    <div class="font-mono text-sm space-y-2">
                        <div class="flex justify-between gap-3"><span class="font-semibold">Account</span><span class="text-right">${tx.account_name || ''}</span></div>
                        <div class="flex justify-between gap-3"><span class="font-semibold">Sort Code</span><span class="text-right">${tx.sort_code || ''}</span></div>
                        <div class="flex justify-between gap-3"><span class="font-semibold">Account Number</span><span class="text-right">${tx.account_number || ''}</span></div>
                        <div class="flex justify-between gap-3"><span class="font-semibold">Date</span><span class="text-right">${tx.date}</span></div>
                        <div class="flex justify-between gap-3"><span class="font-semibold">Description</span><span class="text-right">${tx.description}</span></div>
                        <div class="flex justify-between gap-3"><span class="font-semibold">Memo</span><span class="text-right">${tx.memo || ''}</span></div>
                        <div class="flex justify-between gap-3 border-y border-dashed border-amber-300 py-2 mt-2">
                            <span class="font-semibold uppercase tracking-wide">Total</span><span class="text-right font-semibold">Â£${parseFloat(tx.amount).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between gap-3"><span class="font-semibold">OFX Type</span><span class="text-right">${tx.ofx_type || ''}</span></div>
                        ${tx.ofx_id ? `<div class="flex justify-between gap-3"><span class="font-semibold">OFX ID</span><span class="text-right">${tx.ofx_id}</span></div>` : ''}
                        ${tx.bank_ofx_id ? `<div class="flex justify-between gap-3"><span class="font-semibold">Bank OFX ID</span><span class="text-right">${tx.bank_ofx_id}</span></div>` : ''}
                        <div class="flex justify-between gap-3"><span class="font-semibold">Transfer</span><span class="text-right">${tx.transfer_id ? '<span class="text-blue-700"><i class="fas fa-right-left inline w-4 h-4 mr-1" aria-hidden="true"></i>Yes (ID ' + tx.transfer_id + ')</span>' : 'No'}</span></div>
                    </div>
                    <div class="pt-2 border-t border-dashed border-amber-300 space-y-2">
                        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Assigned labels</p>
                        <div id="assigned-meta" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="pt-6 space-y-4">
                    <label class="block">Tag: <input type="text" id="tag" class="border p-2 rounded w-full" data-help="Enter a new tag name to auto-tag similar transactions"></label>
                    <label class="block">Category Group: <select id="category" class="border p-2 rounded w-full" data-help="Assign a category group"></select></label>
                    <label class="block">Group: <select id="group" class="border p-2 rounded w-full" data-help="Assign a group"></select></label>
                </div>
                <div class="flex space-x-2 justify-center no-print">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded" aria-label="Save transaction">Save</button>
                    <button type="button" id="print" class="bg-gray-600 text-white px-4 py-2 rounded" aria-label="Print receipt">Print Receipt</button>
                </div>
            `;
            form.querySelector('#assigned-meta').appendChild(metaChips);
            card.appendChild(form);
            container.appendChild(card);
            const printBtn = form.querySelector('#print');
            if (printBtn) {
                printBtn.addEventListener('click', () => window.print());
            }
            const tagInput = form.querySelector('#tag');
            if (tx.tag_name) {
                tagInput.parentElement.classList.add('hidden');
            }
            const groupSel = form.querySelector('#group');
            const catSel = form.querySelector('#category');
            tagInput.value = tx.tag_name || '';
            const blankGrp = document.createElement('option');
            blankGrp.value = '';
            blankGrp.textContent = '-- None --';
            groupSel.appendChild(blankGrp);
            groups.forEach(g => {
                if (g.active || g.id == tx.group_id) {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    if (g.id == tx.group_id) opt.selected = true;
                    else if (!g.active) opt.disabled = true;
                    groupSel.appendChild(opt);
                }
            });
            const blankCat = document.createElement('option');
            blankCat.value = '';
            blankCat.textContent = '-- None --';
            catSel.appendChild(blankCat);
            const segMap = {};
            categories.forEach(c => {
                const seg = c.segment_name || 'Unassigned';
                if (!segMap[seg]) {
                    const og = document.createElement('optgroup');
                    og.label = seg;
                    segMap[seg] = og;
                    catSel.appendChild(og);
                }
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                if (c.id == tx.category_id) opt.selected = true;
                segMap[seg].appendChild(opt);
            });
            const newGrp = document.createElement('option');
            newGrp.value = '__new';
            newGrp.textContent = 'Add New Group...';
            groupSel.appendChild(newGrp);

            groupSel.addEventListener('change', () => {
                if (groupSel.value === '__new') {
                    const name = prompt('Enter new group name:');
                    if (!name) { groupSel.value = ''; return; }
                    fetch('../php_backend/public/groups.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    }).then(r => r.json()).then(res => {
                        if (res.id) {
                            const opt = document.createElement('option');
                            opt.value = res.id;
                            opt.textContent = name;
                            groupSel.insertBefore(opt, newGrp);
                            groupSel.value = res.id;
                            showMessage('Group created');
                        } else {
                            alert('Failed to create group');
                            groupSel.value = '';
                        }
                    }).catch(() => {
                        alert('Failed to create group');
                        groupSel.value = '';
                    });
                }
            });

            form.addEventListener('submit', function(ev){
                ev.preventDefault();
                const payload = {
                    transaction_id: tx.id,
                    account_id: tx.account_id,
                    description: tx.description
                };
                if (groupSel.value !== '') payload.group_id = groupSel.value;
                if (catSel.value !== '') payload.category_id = catSel.value;
                if (tx.tag_id) payload.tag_id = tx.tag_id;
                else if (tagInput.value.trim() !== '') payload.tag_name = tagInput.value.trim();

                fetch('../php_backend/public/update_transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r => r.json()).then(res => {
                    if (res && res.status === 'ok') {
                        showMessage('Saved');
                        setTimeout(() => {
                            if (document.referrer) {
                                window.location = document.referrer;
                            } else {
                                history.back();
                            }
                        }, 500);
                    } else {
                        alert('Failed to save');
                    }
                }).catch(() => alert('Failed to save'));
            });
        });
    }
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>

<!DOCTYPE html>
<!-- Page for managing monthly category budgets -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Budgets</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_simple.min.css">
    <!-- Font Awesome icons loaded via menu.js -->

</head>
<body class="bg-gradient-to-b from-indigo-50 to-white font-sans">
<div class="flex min-h-screen">
    <nav id="menu" class="w-64 flex-shrink-0 bg-white border-r p-6"></nav>
    <main class="flex-1 min-w-0 overflow-x-auto p-6 space-y-6">
        <h1 class="text-2xl font-semibold mb-4 text-indigo-700">Budgets</h1>
        <p class="mb-4">Set monthly spending limits for categories and monitor progress. Use this page to plan ahead and see where you may need to adjust your spending.</p>
        <section>
            <form id="budget-form" class="md:flex md:space-x-4 space-y-4 md:space-y-0">
                <label class="block">Month<br><input type="month" id="month" class="border p-2 rounded" data-help="Month for the budget"></label>
                <label class="block">Category<br><select id="category" class="border p-2 rounded" data-help="Category to assign the budget"></select></label>
                <label class="block">Amount (£)<br><input type="number" step="0.01" id="amount" class="border p-2 rounded" data-help="Budget amount in pounds"></label>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded self-end">Set Budget</button>
            </form>
        </section>
        <section class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">AI Budgeting</h2>

            <p class="mb-4">Send your savings goal and the last 12 months of category totals to the AI to propose next month's budgets and provide a brief explanation.</p>
            <form id="ai-form" class="md:flex md:space-x-4 space-y-4 md:space-y-0">
                <label class="block">Savings Goal (£)<br><input type="number" step="0.01" id="goal" class="border p-2 rounded" data-help="Monthly amount you want to save. The AI uses this plus a year of history to set budgets."></label>
                <button id="ai-run" type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded self-end"><i class="fas fa-robot inline w-4 h-4 mr-1"></i>Generate Budgets</button>
            </form>
            <div id="ai-result" class="mt-4"></div>

        </section>
        <section>
            <h2 class="text-xl font-semibold mb-4">Current Budgets</h2>
            <div id="budget-table"></div>
        </section>
        <section>
            <h2 class="text-xl font-semibold mb-4">Budget Progress</h2>
            <div id="budget-chart" style="height:400px"></div>
        </section>
    </main>
</div>
<script src="js/menu.js"></script>
<script src="js/input_help.js"></script>
<script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
<script src="js/tabulator-tailwind.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
// Format a number as currency with a pound symbol
function formatCurrency(value){return '£'+parseFloat(value).toFixed(2);}
let budgetTable;
const monthInput=document.getElementById('month');
monthInput.value=new Date().toISOString().slice(0,7);

// Populate the category select with options from the server
async function loadCategories(){
    const res=await fetch('../php_backend/public/categories.php');
    const cats=await res.json();
    const sel=document.getElementById('category');
    sel.innerHTML='';
    cats.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt);
    });
}

// Fetch and display budgets for the selected month
async function loadBudgets(){
    const [year,month]=monthInput.value.split('-');
    const res=await fetch(`../php_backend/public/budgets.php?month=${parseInt(month)}&year=${parseInt(year)}`);
    const data=await res.json();
    if(budgetTable){budgetTable.setData(data);}else{
        budgetTable=tailwindTabulator('#budget-table',{
            data:data,
            layout: 'fitDataStretch',
            columns:[
                {title:'Category',field:'category'},
                {title:'Budget',field:'amount',formatter:'money',formatterParams:{symbol:'£',precision:2},hozAlign:'right'},
                {title:'Spent',field:'spent',formatter:'money',formatterParams:{symbol:'£',precision:2},hozAlign:'right'},
                {title:'Left',field:'left',formatter:'money',formatterParams:{symbol:'£',precision:2},hozAlign:'right'},
                {formatter:()=>'<i class="fas fa-trash w-4 h-4"></i>',width:40,hozAlign:'center',cellClick:async(e,cell)=>{
                    if(!confirm('Delete this budget?')) return;
                    const id=cell.getRow().getData().id;
                    await fetch('../php_backend/public/budgets.php',{
                        method:'DELETE',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({id})
                    });
                    loadBudgets();
                    showMessage('Budget deleted');
                }}
            ]
        });
    }
    Highcharts.chart('budget-chart',{
        chart:{type:'column'},
        title:{text:''},
        xAxis:{categories:data.map(b=>b.category)},
        yAxis:{title:{text:'£'}},
        series:[
            {name:'Budget',data:data.map(b=>parseFloat(b.amount))},
            {name:'Spent',data:data.map(b=>parseFloat(b.spent))}
        ]
    });
}

monthInput.addEventListener('change',loadBudgets);

document.getElementById('budget-form').addEventListener('submit',async e=>{
    e.preventDefault();
    const [year,month]=monthInput.value.split('-');
    const category=document.getElementById('category').value;
    const amount=document.getElementById('amount').value;
    await fetch('../php_backend/public/budgets.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({category_id:category,amount:amount,month:parseInt(month),year:parseInt(year)})
    });
    document.getElementById('amount').value='';
    loadBudgets();
    showMessage('Budget saved');
});

document.getElementById('ai-form').addEventListener('submit',async e=>{
    e.preventDefault();
    const [year,month]=monthInput.value.split('-');
    const goal=document.getElementById('goal').value;

    const resultEl=document.getElementById('ai-result');
    const btn=document.getElementById('ai-run');
    btn.disabled=true;
    btn.classList.add('opacity-50','cursor-not-allowed');
    resultEl.innerHTML='<i class="fas fa-spinner fa-spin inline w-4 h-4 mr-2"></i>Submitting to AI...';
    showMessage('AI budgeting started');
    try{
        const res=await fetch('../php_backend/public/ai_budget.php',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({goal:parseFloat(goal),month:parseInt(month),year:parseInt(year)})
        });
        resultEl.innerHTML='<i class="fas fa-spinner fa-spin inline w-4 h-4 mr-2"></i>Awaiting AI response...';
        const data=await res.json();
        if(data.status==='ok'){
            document.getElementById('goal').value='';
            loadBudgets();
            resultEl.textContent=data.summary||'AI budgets applied.';
            showMessage('AI budgets applied');
        }else{
            resultEl.textContent=data.error||'AI budgeting failed.';
            showMessage('AI budgeting failed','error');
        }
    }catch(err){
        resultEl.textContent='Request failed';
        showMessage('AI budgeting failed','error');
    }finally{
        btn.disabled=false;
        btn.classList.remove('opacity-50','cursor-not-allowed');

    }
});

loadCategories().then(loadBudgets);
</script>
<script src="js/overlay.js"></script>
<script src="js/page_help.js"></script>
</body>
</html>

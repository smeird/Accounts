<!DOCTYPE html>
<!-- Dashboard focused on group spending details -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Group Dashboard</title>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = { darkMode: "class" };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator_simple.min.css">

</head>
<body class="bg-gradient-to-b from-indigo-50 to-white font-sans dark:from-gray-900 dark:to-gray-800 dark:text-gray-100">
    <div class="flex min-h-screen">
        <nav id="menu" class="hidden md:flex md:flex-col w-64 flex-shrink-0 bg-white border-r p-6 overflow-y-auto dark:bg-gray-800 dark:border-gray-700"></nav>
        <main class="flex-1 min-w-0 overflow-x-auto p-6">
            <h1 class="text-2xl font-semibold mb-4 text-indigo-700">Group Dashboard</h1>
            <p class="mb-4">Review group spending by month and year to see how different areas of your budget change over time.</p>
            <label for="year-select" class="block">Year:
                <select id="year-select" class="border p-2 rounded w-full" data-help="Select year"></select>
            </label>

            <h2 class="text-xl font-semibold mt-6 mb-2">Monthly Totals</h2>
            <div class="bg-white p-6 rounded shadow border border-gray-400 dark:bg-gray-800 dark:border-gray-700">
                <div id="month-table"></div>
                <div id="month-chart" class="mt-4" style="height:400px" data-chart-desc="Column chart of monthly totals for each group."></div>
            </div>

            <h2 class="text-xl font-semibold mt-6 mb-2">Yearly Totals</h2>
            <div class="bg-white p-6 rounded shadow border border-gray-400 dark:bg-gray-800 dark:border-gray-700">
                <div id="year-table"></div>
                <div id="year-chart" class="mt-4" style="height:400px" data-chart-desc="Column chart of yearly totals for each group."></div>
            </div>
        </main>
    </div>
    <script src="js/menu.js"></script>
    <script src="js/input_help.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script src="js/tabulator-tailwind.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="js/color_map.js"></script>
    <script>
    function columnTooltip(){
        const total = this.series.yData.reduce((sum, v) => sum + v, 0);
        const pct = total ? (this.y / total * 100) : 0;
        return `<b>${this.series.name}</b><br/>${this.category}: £${Highcharts.numberFormat(this.y, 2)} (${Highcharts.numberFormat(pct, 1)}% of total)`;
    }
    // Format totals with currency and highlight positive/negative values
    function totalFormatter(cell){
        const value = cell.getValue();
        const el = cell.getElement();
        el.classList.toggle('text-red-600', value < 0);
        el.classList.toggle('text-green-600', value > 0);
        return '£' + parseFloat(value).toFixed(2);
    }

    // Render a table of monthly totals for each group
    function buildMonthTable(data){
        const el = document.getElementById('month-table');
        el.innerHTML = '';
        const monthCols = Array.from({length:12}, (_,i) => ({
            title: new Date(0,i).toLocaleString('default', {month:'short'}),
            field: String(i+1),
            formatter: 'money',
            formatterParams: { symbol: '£', precision: 2 },
            hozAlign: 'right',
            bottomCalc: 'sum',
            bottomCalcFormatter: totalFormatter
        }));
        const columns = [
            {
                title: 'Name',
                field: 'name',
                bottomCalc: () => 'Total',
                formatter: function(cell){
                    const value = cell.getValue();
                    const badge = createBadge(value, 'bg-purple-200 text-purple-800');
                    const link = document.createElement('a');
                    link.href = `search.html?value=${encodeURIComponent(value)}`;
                    link.appendChild(badge);
                    return link;
                }
            },
            ...monthCols,
            { title: 'Total', field: 'total', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right', bottomCalc: 'sum', bottomCalcFormatter: totalFormatter }
        ];
        tailwindTabulator(el, { data, layout: 'fitDataStretch', columns });
    }

    // Render a table of yearly totals for each group
    function buildYearTable(data, years){
        const el = document.getElementById('year-table');
        el.innerHTML = '';
        const yearCols = years.map(y => ({
            title: y,
            field: String(y),
            formatter: 'money',
            formatterParams: { symbol: '£', precision: 2 },
            hozAlign: 'right',
            bottomCalc: 'sum',
            bottomCalcFormatter: totalFormatter
        }));
        const columns = [
            {
                title: 'Name',
                field: 'name',
                bottomCalc: () => 'Total',
                formatter: function(cell){
                    const value = cell.getValue();
                    const badge = createBadge(value, 'bg-purple-200 text-purple-800');
                    const link = document.createElement('a');
                    link.href = `search.html?value=${encodeURIComponent(value)}`;
                    link.appendChild(badge);
                    return link;
                }
            },
            ...yearCols,
            { title: 'Total', field: 'total', formatter: 'money', formatterParams: { symbol: '£', precision: 2 }, hozAlign: 'right', bottomCalc: 'sum', bottomCalcFormatter: totalFormatter }
        ];
        tailwindTabulator(el, { data, layout: 'fitDataStretch', columns });
    }

    // Create a column chart for the supplied dataset
    function buildChart(id, title, data){
        Highcharts.chart(id, {
            colors: chartColors,
            chart: { type: 'column' },
            title: { text: title },
            xAxis: { categories: data.map(d => d.name) },
            yAxis: { title: { text: 'Amount (£)' }, labels: { formatter: function(){ return '£' + Highcharts.numberFormat(this.value,2); } } },
            tooltip: { pointFormatter: columnTooltip },
            series: [{ name: 'Total', data: data.map(d => parseFloat(d.total)), colorByPoint: true }]
        });
    }

    // Fetch dashboard data for the selected year and populate tables and charts
    async function load(){
        const year = document.getElementById('year-select').value;
        const res = await fetch('../php_backend/public/group_dashboard.php?year=' + year);
        const data = await res.json();
        const select = document.getElementById('year-select');
        if (!select.options.length){
            data.years.sort((a,b) => b - a).forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                select.appendChild(opt);
            });
            select.value = data.year;
        }
        buildMonthTable(data.byYear);
        buildChart('month-chart', 'Group Totals ' + data.year, data.byYear);
        buildYearTable(data.allYears, data.years);
        buildChart('year-chart', 'Group Totals by Year', data.allYears);
    }

    document.addEventListener('DOMContentLoaded', () => {
        load();
        document.getElementById('year-select').addEventListener('change', load);
    });
    </script>
    <script src="js/overlay.js"></script>
</body>
</html>
